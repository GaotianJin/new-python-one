<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.fms.service.mapper.FeeCalculationServiceMapper" >
	<sql id="getRiskCounterFeeRateCondition">
		<if test="pdRiskId!=null and pdRiskId!=''">
		   	AND A.PD_RISK_ID = #{pdRiskId}
		</if>
		<if test="policyYear!=null and policyYear!=''">
		   	AND A.PARAM_TYPE = #{policyYear}
		</if>
		<if test="payPeriod!=null and payPeriod!=''">
		   	AND A.PARAM_VALUE = #{payPeriod}
		</if>
		<if test="payPeriodUnit!=null and payPeriodUnit!=''">
		   	AND A.PARAM_UNIT = #{payPeriodUnit}
		</if>
		<if test="actuPremium!=null and actuPremium!=''">
		   	AND IFNULL(A.PREM_LOWER,0) <![CDATA[<=]]> #{actuPremium} 
		   	AND IFNULL(A.PREM_UPPER,100000000)<![CDATA[>]]> #{actuPremium}
		</if>
		<if test="calDate!=null and calDate!=''">
		   	AND A.EXEC_START_DATE <![CDATA[<=]]> DATE'${calDate}' 
		   	AND IFNULL(A.EXEC_END_DATE,DATE'9999-12-31')<![CDATA[>]]> DATE'${calDate}'
		</if>
	</sql>
	
	
 	<select id="getRiskCounterFeeRate" resultType="java.lang.Double" parameterType="java.util.Map">
		SELECT A.FEE_RATE 
		FROM T_PD_RISK_FEE_RATE A
		WHERE A.FEE_TYPE = '01'
		AND A.EXEC_STATE = '1'
		<include refid="getRiskCounterFeeRateCondition"/>
		AND A.RC_STATE = 'E'
 	</select>
 	
 	<select id="getConsultationServiceFeeRate" resultType="java.lang.Double" parameterType="java.util.Map">
 	
 	<!--s-->
 	
		SELECT C.FEE_RATE 
		FROM T_PD_PRODUCT A,T_PD_WEALTH B,T_PD_WEALTH_FEE_RATE C
		WHERE A.PRODUCT_ID = B.PRODUCT_ID
		AND B.PD_WEALTH_ID = C.PD_WEALTH_ID
		AND A.PRODUCT_TYPE = '1'
		AND A.PRODUCT_SUB_TYPE = '02'
		AND IFNULL(C.SUBSCRIPTION_FEE_LOWER,0)<![CDATA[<=]]>#{actuSubscriptionAmount}
		AND IFNULL(C.SUBSCRIPTION_FEE_UPPER,10000000000)<![CDATA[>]]>#{actuSubscriptionAmount}
		AND A.PRODUCT_ID = #{productId}
		AND A.RC_STATE = 'E'
		AND B.RC_STATE = 'E'
		AND C.RC_STATE = 'E'
		AND C.FEE_TYPE='01'
 	</select>
 	
 	<select id="getBeforeDateMaxNetValue" resultType="java.lang.Double" parameterType="java.util.Map">
 	
 	<!--s-->
 	
 		SELECT MAX(IFNULL(A.NET_VALUE,0))
		FROM T_PD_WEALTH_NET_VALUE A ,T_PD_WEALTH_OPEN_DATE B
		WHERE A.PD_WEALTH_ID = #{pdWealthId}
		    AND A.PD_WEALTH_ID = B.PD_WEALTH_ID
		    AND A.PUBLIC_DATE = B.OPEN_DATE
		AND A.PUBLIC_DATE <![CDATA[<]]> DATE'${publicDate}'
		AND A.RC_STATE = 'E'
		AND B.RC_STATE = 'E'
 	</select>
 	
 	
</mapper>


