<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fms.service.mapper.ProductOrderServiceMapper">	
	<!-- 预约申请查询条件-->
	<sql id="queryComPdAmountOrderInfoCondition">
		<if test='agencyComId != null and agencyComId != ""'>
			AND B.AGENCY_COM_ID = #{agencyComId}
		</if>
		<if test='productId != null and productId != ""'>
			AND A.PRODUCT_ID = #{productId}
		</if>
	</sql>
	<sql id="queryComPdAmountOrderInfoCondition1">
		<if test='expectOpenDayStart != null and expectOpenDayStart != ""'>
			AND nAlias.expectOpenDay >= #{expectOpenDayStart}
		</if>
		<if test='expectOpenDayEnd != null and expectOpenDayEnd != ""'>
			AND #{expectOpenDayEnd} >= nAlias.expectOpenDay
		</if>
		<if test='investEndDateStart != null and investEndDateStart != ""'>
			AND nAlias.investEndDate >= #{investEndDateStart}
		</if>
		<if test='investEndDateEnd != null and investEndDateEnd != ""'>
			AND #{investEndDateEnd} >= nAlias.investEndDate
		</if>
		<if test='foundDateStart != null and foundDateStart != ""'>
			AND nAlias.foundDate >= #{foundDateStart}
		</if>
		<if test='foundDateEnd != null and foundDateEnd != ""'>
			AND #{foundDateEnd} >= nAlias.foundDate
		</if>
	</sql>
	
	<!-- 预约申请查询 -->
	<select id="queryComPdAmountOrderInfoList" parameterType="java.util.Map"
		resultType="java.util.Map">
		
		
  <!--s-->
		select tAlias.*
		from (select nAlias.*, @rownum:=@rownum+1 r_rownum
		from
		(
		  SELECT (SELECT @rownum := 0),
		         PD_AMOUNT_ORDER_INFO.*,
			     (CASE WHEN investStartDate>'${currentTime}' THEN '01'
			                  WHEN (investStartDate<![CDATA[<=]]>'${currentTime}' 
			                       AND '${currentTime}'<![CDATA[<=]]>investEndDate) THEN '02'
			                  WHEN investEndDate <![CDATA[<]]>'${currentTime}' THEN '03' END) "pdOrderStatus",
			     (CASE WHEN investStartDate<![CDATA[>]]>'${currentTime}' 
			                  THEN FUNC_GET_CODE_NAME('pdOrderStatus','01')
			                  WHEN (investStartDate<![CDATA[<=]]>'${currentTime}' 
			                       AND '${currentTime}'<![CDATA[<=]]>investEndDate) 
			                  THEN FUNC_GET_CODE_NAME('pdOrderStatus','02')
			                  WHEN investEndDate <![CDATA[<]]>'${currentTime}'
			                  THEN FUNC_GET_CODE_NAME('pdOrderStatus','03') END) "pdOrderStatusName"
			FROM    
			    (SELECT A.COM_ID "comId",C.AGENCY_COM_ID "agencyComId",C.AGENCY_NAME "agencyComName",
			             B.PRODUCT_ID "productId",B.PRODUCT_NAME "productName",
			             B.PRODUCT_TYPE "productType",B.PRODUCT_SUB_TYPE "productSubType",B.REMARK "remark",
			             (CASE WHEN B.PRODUCT_TYPE = '1' AND B.PRODUCT_SUB_TYPE  in ('03','04')
			                            THEN DATE_FORMAT(A.EXPECT_OPEN_DAY,'%Y-%m-%d')
		                       WHEN B.PRODUCT_TYPE = '1' AND B.PRODUCT_SUB_TYPE in ('01','02')
			                       		THEN '' END ) "expectOpenDay",
			             DATE_FORMAT(D.FOUND_DATE,'%Y-%m-%d') "foundDate",A.AMOUNT "amount",
			             A.AMOUNT-(SELECT IFNULL(SUM(IFNULL(E.ORDER_AMOUNT,0)),0)  
			                              FROM T_PD_AMOUNT_ORDER_INFO E WHERE E.PRODUCT_ID = B.PRODUCT_ID 
			                                   AND E.COM_ID = A.COM_ID AND E.EXPECT_OPEN_DAY = A.EXPECT_OPEN_DAY
			                                   AND E.ORDER_STATUS IN('01','02') 
			                                   AND E.RC_STATE = 'E') "remainAmount",
			            IFNULL(B.IS_INVITE_CODE,'02') "isInviteCode",
			             FUNC_GET_CODE_NAME('isInviteCode',IFNULL(B.IS_INVITE_CODE,'02'))"isInviteCodeName", 
			             (CASE WHEN B.PRODUCT_TYPE = '1' AND B.PRODUCT_SUB_TYPE in ('03','04')
			                            THEN (SELECT DATE_FORMAT(F.INVEST_START_DATE,'%Y-%m-%d %H:%i:%S') FROM T_PD_WEALTH_OPEN_DATE F 
			                                 WHERE F.PD_WEALTH_ID = D.PD_WEALTH_ID 
			                                 AND F.OPEN_DATE = A.EXPECT_OPEN_DAY AND F.RC_STATE= 'E') 
			                       WHEN B.PRODUCT_TYPE = '1' AND B.PRODUCT_SUB_TYPE in ('01','02')
			                            THEN DATE_FORMAT(D.RAISE_START_DATE,'%Y-%m-%d %H:%i:%S') END ) "investStartDate",
			             (CASE WHEN B.PRODUCT_TYPE = '1' AND B.PRODUCT_SUB_TYPE in ('03','04')
			                      THEN (SELECT DATE_FORMAT(F.INVEST_END_DATE,'%Y-%m-%d %H:%i:%S') FROM T_PD_WEALTH_OPEN_DATE F 
			                           WHERE F.PD_WEALTH_ID = D.PD_WEALTH_ID 
			                           AND F.OPEN_DATE = A.EXPECT_OPEN_DAY AND F.RC_STATE= 'E') 
			                 WHEN B.PRODUCT_TYPE = '1' AND B.PRODUCT_SUB_TYPE in ('01','02')
			                      THEN DATE_FORMAT(D.RAISE_END_DATE,'%Y-%m-%d %H:%i:%S') END ) "investEndDate",
			              'Y' AS "isDistribute"
			      FROM T_PD_AMOUNT_DIS_INFO A,T_PD_PRODUCT B,T_AGENCY_COM C,T_PD_WEALTH D
			      WHERE A.PRODUCT_ID = B.PRODUCT_ID
				      AND B.AGENCY_COM_ID = C.AGENCY_COM_ID
				      AND B.PRODUCT_ID = D.PRODUCT_ID
				      AND A.COM_ID = #{comId}
				      AND B.STATUS = '2'
				      <include refid="queryComPdAmountOrderInfoCondition"/>
				      AND A.RC_STATE = 'E'
				      AND B.RC_STATE = 'E'
				      AND C.RC_STATE = 'E'
				      AND D.RC_STATE = 'E'
			      UNION <!-- 固收类可预约未分配额度的所有产品 -->
			      SELECT 0 "comId",B.AGENCY_COM_ID "agencyComId",B.AGENCY_NAME "agencyComName",
	                   A.PRODUCT_ID "productId",A.PRODUCT_NAME "productName",
	                   A.PRODUCT_TYPE "productType",A.PRODUCT_SUB_TYPE "productSubType",A.REMARK "remark",
	                   '' AS "expectOpenDay",
	                   DATE_FORMAT(C.FOUND_DATE,'%Y-%m-%d') "foundDate",C.FINANCING_SCALE "amount",
	                   C.FINANCING_SCALE-(SELECT IFNULL(SUM(IFNULL(E.ORDER_AMOUNT,0)),0)  
	                                    FROM T_PD_AMOUNT_ORDER_INFO E WHERE E.PRODUCT_ID = A.PRODUCT_ID 
	                                         AND E.EXPECT_OPEN_DAY = C.FOUND_DATE
	                                         AND E.ORDER_STATUS IN('01','02','05') 
	                                         AND E.RC_STATE = 'E') "remainAmount",
	                   IFNULL(A.IS_INVITE_CODE,'02') "isInviteCode",
	                   FUNC_GET_CODE_NAME('isInviteCode',IFNULL(A.IS_INVITE_CODE,'02'))"isInviteCodeName", 
	                   DATE_FORMAT(C.RAISE_START_DATE,'%Y-%m-%d %H:%i:%S') "investStartDate",
	                  DATE_FORMAT(C.RAISE_END_DATE,'%Y-%m-%d %H:%i:%S') "investEndDate",
			           'N' AS "isDistribute"
	            FROM T_PD_PRODUCT A,T_AGENCY_COM B,T_PD_WEALTH C
		            WHERE A.PRODUCT_ID = C.PRODUCT_ID
		            AND B.AGENCY_COM_ID = A.AGENCY_COM_ID
		            AND A.PRODUCT_TYPE = '1'
		            AND A.PRODUCT_SUB_TYPE in ('01','02')
		            AND A.IS_ORDER = '01'
		            AND A.STATUS = '2'
		            <include refid="queryComPdAmountOrderInfoCondition"/>
		           <!-- AND STR_TO_DATE('${currentTime}','%Y-%m-%d %H:%i:%S') <![CDATA[<=]]> C.RAISE_END_DATE   --> 
		            <!-- AND TO_DATE('${currentTime}','YYYY-MM-DD HH24:MI:SS') BETWEEN C.RAISE_START_DATE AND C.RAISE_END_DATE -->
		            AND NOT EXISTS(SELECT 'X' FROM T_PD_AMOUNT_DIS_INFO WHERE PRODUCT_ID = A.PRODUCT_ID AND RC_STATE = 'E')
		            AND A.RC_STATE = 'E'
		            AND B.RC_STATE = 'E'
		            AND C.RC_STATE = 'E'
			    UNION <!-- 浮收类可预约但未分配额度的产品 -->
			   SELECT 0 "comId",B.AGENCY_COM_ID "agencyComId",B.AGENCY_NAME "agencyComName",
	                   A.PRODUCT_ID "productId",A.PRODUCT_NAME "productName",
	                   A.PRODUCT_TYPE "productType",A.PRODUCT_SUB_TYPE "productSubType",A.REMARK "remark",
	                   DATE_FORMAT(D.OPEN_DATE,'%Y-%m-%d') "expectOpenDay",
	                   DATE_FORMAT(C.FOUND_DATE,'') "foundDate",D.FINANCING_SCALE "amount",
	                   D.FINANCING_SCALE-(SELECT IFNULL(SUM(IFNULL(E.ORDER_AMOUNT,0)),0)  
	                                    FROM T_PD_AMOUNT_ORDER_INFO E WHERE E.PRODUCT_ID = A.PRODUCT_ID 
	                                         AND E.EXPECT_OPEN_DAY = D.OPEN_DATE
	                                         AND E.ORDER_STATUS IN('01','02','05') 
	                                         AND E.RC_STATE = 'E') "remainAmount",
	                  IFNULL(A.IS_INVITE_CODE,'02') "isInviteCode",
	                   FUNC_GET_CODE_NAME('isInviteCode',IFNULL(A.IS_INVITE_CODE,'02'))"isInviteCodeName", 
	                   DATE_FORMAT(D.INVEST_START_DATE,'%Y-%m-%d %H:%i:%S') "investStartDate",
	                   DATE_FORMAT(D.INVEST_END_DATE,'%Y-%m-%d %H:%i:%S') "investEndDate",
			           'N' AS "isDistribute"
	            FROM T_PD_PRODUCT A,T_AGENCY_COM B,T_PD_WEALTH C,T_PD_WEALTH_OPEN_DATE D
	            WHERE A.PRODUCT_ID = C.PRODUCT_ID
		            AND B.AGENCY_COM_ID = A.AGENCY_COM_ID
		            AND C.PD_WEALTH_ID = D.PD_WEALTH_ID
		            AND A.PRODUCT_TYPE = '1'
		            AND A.PRODUCT_SUB_TYPE in ('03','04')
		            AND A.IS_ORDER = '01'
		            AND A.STATUS = '2'
		            AND '${currentTime}'  >= D.INVEST_START_DATE
			        AND D.INVEST_END_DATE>='${currentTime}' 
		            <include refid="queryComPdAmountOrderInfoCondition"/>
		           <!-- AND STR_TO_DATE('${currentTime}','%Y-%m-%d %H:%i:%S') <![CDATA[<=]]> D.INVEST_END_DATE  -->
		            <!-- AND TO_DATE('${currentTime}','YYYY-MM-DD HH24:MI:SS') BETWEEN D.INVEST_START_DATE AND D.INVEST_END_DATE -->
		             AND NOT EXISTS(SELECT 'X' FROM T_PD_AMOUNT_DIS_INFO G WHERE G.PRODUCT_ID = A.PRODUCT_ID 
		                AND G.EXPECT_OPEN_DAY=D.OPEN_DATE AND RC_STATE = 'E')
		            AND A.RC_STATE = 'E'
		            AND B.RC_STATE = 'E'
		            AND C.RC_STATE = 'E'
		            AND D.RC_STATE = 'E'  
			      ) PD_AMOUNT_ORDER_INFO
	     ) nAlias
	     WHERE 1=1 
	     		AND pdOrderStatus != '03'
	     	<if test='pdOrderStatus != null and pdOrderStatus != ""'>
				AND pdOrderStatus = #{pdOrderStatus}
			</if>
			<include refid="queryComPdAmountOrderInfoCondition1"/>
	     ) tAlias
		where  r_rownum >= #{startIndex} and #{endIndex} >= r_rownum
	</select>

	<select id="queryComPdAmountOrderInfoListCount" parameterType="java.util.Map"
		resultType="java.lang.Integer">
		
  <!--s-->
		
		SELECT SUM(COUNT_) 
		FROM(SELECT COUNT(1) COUNT_
					FROM T_PD_AMOUNT_DIS_INFO A,T_PD_PRODUCT B,T_AGENCY_COM C,T_PD_WEALTH D
			      WHERE A.PRODUCT_ID = B.PRODUCT_ID
				      AND B.AGENCY_COM_ID = C.AGENCY_COM_ID
				      AND B.PRODUCT_ID = D.PRODUCT_ID
				      AND A.COM_ID = #{comId}
				      AND B.STATUS = '2'
				      <include refid="queryComPdAmountOrderInfoCondition"/>
				      AND A.RC_STATE = 'E'
				      AND B.RC_STATE = 'E'
				      AND C.RC_STATE = 'E'
				      AND D.RC_STATE = 'E'
				UNION ALL
				SELECT COUNT(1) COUNT_
		       FROM T_PD_PRODUCT A,T_AGENCY_COM B,T_PD_WEALTH C
		            WHERE A.PRODUCT_ID = C.PRODUCT_ID
		            AND B.AGENCY_COM_ID = A.AGENCY_COM_ID
		            AND A.PRODUCT_TYPE = '1'
		            AND A.PRODUCT_SUB_TYPE in ('01','02')
		            AND A.IS_ORDER = '01'
		            AND A.STATUS = '2'
		            <include refid="queryComPdAmountOrderInfoCondition"/>
		           <!-- AND STR_TO_DATE('${currentTime}','%Y-%m-%d %H:%i:%S') <![CDATA[<=]]> C.RAISE_END_DATE   --> 
		            <!-- AND TO_DATE('${currentTime}','YYYY-MM-DD HH24:MI:SS') BETWEEN C.RAISE_START_DATE AND C.RAISE_END_DATE -->
		            AND NOT EXISTS(SELECT 'X' FROM T_PD_AMOUNT_DIS_INFO WHERE PRODUCT_ID = A.PRODUCT_ID AND RC_STATE = 'E')
		            AND A.RC_STATE = 'E'
		            AND B.RC_STATE = 'E'
		            AND C.RC_STATE = 'E'
				UNION ALL
				SELECT COUNT(1) COUNT_
			        FROM T_PD_PRODUCT A,T_AGENCY_COM B,T_PD_WEALTH C,T_PD_WEALTH_OPEN_DATE D
	            WHERE A.PRODUCT_ID = C.PRODUCT_ID
		            AND B.AGENCY_COM_ID = A.AGENCY_COM_ID
		            AND C.PD_WEALTH_ID = D.PD_WEALTH_ID
		            AND A.PRODUCT_TYPE = '1'
		            AND A.PRODUCT_SUB_TYPE in ('03','04')
		            AND A.IS_ORDER = '01'
		            AND A.STATUS = '2'
		            <include refid="queryComPdAmountOrderInfoCondition"/>
		           <!-- AND STR_TO_DATE('${currentTime}','%Y-%m-%d %H:%i:%S') <![CDATA[<=]]> D.INVEST_END_DATE  -->
		            <!-- AND TO_DATE('${currentTime}','YYYY-MM-DD HH24:MI:SS') BETWEEN D.INVEST_START_DATE AND D.INVEST_END_DATE -->
		             AND NOT EXISTS(SELECT 'X' FROM T_PD_AMOUNT_DIS_INFO G WHERE G.PRODUCT_ID = A.PRODUCT_ID 
		                AND G.EXPECT_OPEN_DAY=D.OPEN_DATE AND RC_STATE = 'E')
		            AND A.RC_STATE = 'E'
		            AND B.RC_STATE = 'E'
		            AND C.RC_STATE = 'E'
		            AND D.RC_STATE = 'E' )t
		         
	</select>
	
	<!-- 产品预约查询条件 -->
	<sql id="productAmountOrderInfo">
		<if test='agencyComId!= null and agencyComId!=""'>
			AND C.AGENCY_COM_ID = #{agencyComId}
		</if>
		<if test='productId!= null and productId!=""'>
			AND A.PRODUCT_ID = #{productId}
		</if>
		<if test='custName != null and custName !=""'>
			AND A.CUST_NAME like '%${custName}%'
		</if>
		<if test='comId != null and comId !=""'>
			AND A.COM_ID = #{comId}
		</if>
		<!-- <if test='storeId != null and storeId !=""'>
			AND EXISTS(SELECT 'X' FROM T_AGENT WHERE STORE_ID=#{storeId} AND AGENT_ID = A.agent_id AND RC_STATE = 'E')
		</if> -->
		<!-- h 根据团队查询 -->
		<if test='departmentId != null and departmentId !=""'>
			AND EXISTS(SELECT 'X' FROM T_AGENT WHERE DEPARTMENT_ID=#{departmentId} AND AGENT_ID = A.agent_id AND RC_STATE = 'E')
        </if>
		
		<if test='agentId != null and agentId !=""'>
			AND A.agent_id = #{agentId}
		</if>
		<if test='orderAmount != null and orderAmount !=""'>
			AND A.ORDERA_MOUNT = #{orderAmount}
		</if>
		<!-- <if test="productSubType != null and productSubType !=''"> AND A.PRODUCT_SUB_TYPE 
			= #{productSubType} </if> -->
		<if test='orderDate != null and orderDate !=""'>
			AND  DATE_FORMAT(A.CREATE_DATE,'%Y-%m-%d') = #{orderDate}
		</if>
		<if test='inviteCode!= null and inviteCode!=""'>
			AND D.RAISE_END_DATE = #{inviteCode}
		</if>
		<if test='orderStatus!= null and orderStatus!=""'>
			AND A.ORDER_STATUS = #{orderStatus}
		</if>
		<!-- 以下是查询权限控制 3-本机构及下属机构数据，2-本机构数据，1-本人数据 -->
		<if
			test='rolePrivilege!=null and rolePrivilege!=null and rolePrivilege=="1"'> 
			and a.agent_id in (select x.agent_id
			from t_agent x
			where x.user_id = #{createUserId}
			and x.rc_state = 'E')
		</if>
		<if
			test='rolePrivilege!=null and rolePrivilege!=null and rolePrivilege=="2" '>
           and a.agent_id in (select x.agent_id
                              from t_agent x
                                where x.com_id = #{operComId}
                                  and x.rc_state = 'E')
		</if>
		<if
			test='rolePrivilege!=null and rolePrivilege!=null and rolePrivilege=="3" '>
			
	 <!--S-->
			 
           and a.agent_id in (select x.agent_id
                 from t_agent x
                where x.com_id in 
                      (<!-- SELECT Y.COM_ID
                         FROM T_DEF_COM Y
                        WHERE Y.RC_STATE = 'E'
                          AND Y.STATE = '01'
                        START WITH Y.COM_ID = #{operComId}
                       CONNECT BY PRIOR Y.COM_ID = Y.PARENT_COM_ID -->
                       select Y.COM_ID from t_def_com Y 
						where Y.RC_STATE = 'E'
                          AND Y.STATE = '01'
						AND FIND_IN_SET(Y.COM_ID, queryChildrenNodeInfo(#{operComId}))
                       
                       )
                  and x.rc_state = 'E')
		</if>
		<!-- 权限控制结束 -->
	</sql>
	
	<select id="getAllPdAmountOrderInfo" parameterType="java.util.Map"
		resultType="java.util.Map">
		
		  <!--s-->
	select tAlias.*
	from (select nAlias.*,@rownum:=@rownum+1 r_rownum
	from(SELECT (SELECT @rownum := 0),
	A.PD_AMOUNT_ORDER_INFO_ID "pdAmountOrderInfoId",A.PRODUCT_ID "productId",
	B.PRODUCT_NAME "productName",B.PRODUCT_TYPE "productType",B.PRODUCT_SUB_TYPE
	"productSubType",B.REMARK "remark",
	C.AGENCY_COM_ID"agencyComId",C.AGENCY_NAME "agencyName",A.CUST_NAME"custName",
	A.COM_ID "comId",(SELECT COM_NAME FROM T_DEF_COM WHERE COM_ID=A.COM_ID AND
	RC_STATE='E')"comName",
	H.AGENT_ID "agentId",H.AGENT_NAME "agentName",<!-- H.STORE_ID "storeId", (SELECT G.STORE_NAME 
		FROM T_DEF_STORE G WHERE G.STORE_ID = H.STORE_ID AND G.RC_STATE = 'E')"storeName", -->
	A.ORDER_AMOUNT "orderAmount",DATE_FORMAT(A.CREATE_DATE,'%Y-%m-%d')"orderDate",
	A.INVITE_CODE"inviteCode",
	A.PLAN_TRANSFER_DATE "planTransferDate",
	A.ORDER_STATUS "orderStatus",
	FUNC_GET_CODE_NAME('custOrderStatus',A.ORDER_STATUS) "orderStatusName",
	DATE_FORMAT(a.expect_open_day,'%Y-%m-%d ') "expectOpenDay",
	DATE_FORMAT(D.FOUND_DATE,'%Y-%m-%d ') "foundDate",
	DATE_FORMAT(D.RAISE_END_DATE,'%Y-%m-%d ') "investEndDate",
	(CASE WHEN (SELECT COUNT(1) FROM T_PD_AMOUNT_DIS_INFO E WHERE E.PRODUCT_ID =
	A.PRODUCT_ID
	AND E.COM_ID = A.COM_ID AND E.EXPECT_OPEN_DAY = A.EXPECT_OPEN_DAY
	AND E.RC_STATE = 'E')>0
	THEN 'Y' ELSE 'N' END) "isDistribute"
	FROM T_PD_AMOUNT_ORDER_INFO A,T_PD_PRODUCT B,T_AGENCY_COM C,T_PD_WEALTH
	D,T_AGENT H
	WHERE A.PRODUCT_ID = B.PRODUCT_ID
	AND B.AGENCY_COM_ID =C.AGENCY_COM_ID
	AND B.PRODUCT_ID = D.PRODUCT_ID
	AND A.AGENT_ID = H.AGENT_ID
	AND B.STATUS = '2'
	AND A.RC_STATE = 'E'
	AND B.RC_STATE = 'E'
	AND C.RC_STATE = 'E'
	AND D.RC_STATE = 'E'
	AND H.RC_STATE = 'E'
	AND case
	when B.PRODUCT_SUB_TYPE='01' OR B.PRODUCT_SUB_TYPE='02'
	THEN
	CURRENT_TIMESTAMP <![CDATA[>=]]> D.RAISE_START_DATE
	AND CURRENT_TIMESTAMP <![CDATA[<=]]> DATE_ADD(D.RAISE_END_DATE,INTERVAL 2 DAY)
	ELSE 
	EXISTS(SELECT 'X' FROM t_pd_wealth
	X,t_pd_wealth_open_date Y
	WHERE X.PRODUCT_ID=B.PRODUCT_ID
	AND
	X.PD_WEALTH_ID = Y.PD_WEALTH_ID
	AND CURRENT_TIMESTAMP <![CDATA[>=]]>
	Y.INVEST_START_DATE
	AND CURRENT_TIMESTAMP <![CDATA[<=]]>
	DATE_ADD(a.expect_open_day,INTERVAL 2 DAY))
	END
	<include refid="productAmountOrderInfo" />
	ORDER BY A.CREATE_DATE DESC
	) nAlias
	) tAlias
	where r_rownum>= #{startIndex} and #{endIndex} >= r_rownum 
	</select>

	<select id="getAllPdAmountOrderInfoCount" parameterType="java.util.Map"
		resultType="java.lang.Integer">
	SELECT COUNT(1)
	FROM T_PD_AMOUNT_ORDER_INFO A,T_PD_PRODUCT B,T_AGENCY_COM C,T_PD_WEALTH
	D,T_AGENT H
	WHERE A.PRODUCT_ID = B.PRODUCT_ID
	AND B.AGENCY_COM_ID =C.AGENCY_COM_ID
	AND B.PRODUCT_ID = D.PRODUCT_ID
	AND A.AGENT_ID = H.AGENT_ID
	AND B.STATUS = '2'
	AND A.RC_STATE = 'E'
	AND B.RC_STATE = 'E'
	AND C.RC_STATE = 'E'
	AND D.RC_STATE = 'E'
	AND H.RC_STATE = 'E'
	AND case
	when B.PRODUCT_SUB_TYPE='01' OR B.PRODUCT_SUB_TYPE='02'
	THEN
	CURRENT_TIMESTAMP <![CDATA[>=]]> D.RAISE_START_DATE
	AND CURRENT_TIMESTAMP <![CDATA[<=]]> DATE_ADD(D.RAISE_END_DATE,INTERVAL 2 DAY)
	ELSE EXISTS(SELECT 'X' FROM t_pd_wealth
	X,t_pd_wealth_open_date Y
	WHERE X.PRODUCT_ID=B.PRODUCT_ID
	AND
	X.PD_WEALTH_ID = Y.PD_WEALTH_ID
	AND CURRENT_TIMESTAMP <![CDATA[>=]]>
	Y.INVEST_START_DATE
	AND CURRENT_TIMESTAMP <![CDATA[<=]]>
	DATE_ADD(a.expect_open_day,INTERVAL 2 DAY))
	END
			  <include refid="productAmountOrderInfo" />
	</select>
	
	<!-- 产品队列预约信息查询 -->
	<select id="getRemainAmountOrderInfo" parameterType="java.util.Map"
		resultType="java.util.Map">
	SELECT
					(@rowNum:=@rowNum+1) as "serialNo",
					t.*
					FROM(SELECT
	A.PD_AMOUNT_ORDER_QUEUE_INFO_ID "pdAmountOrderQueueInfoId",
  A.PRODUCT_ID "productId",
  A.QUEUE_NO "queueNo",
	B.PRODUCT_NAME "productName",
  B.PRODUCT_TYPE "productType",
  B.PRODUCT_SUB_TYPE "productSubType",
  B.REMARK "remark",
	C.AGENCY_COM_ID "agencyComId",
  C.AGENCY_NAME "agencyName",
  A.CUST_NAME"custName",
	A.COM_ID "comId",
  (SELECT COM_NAME FROM T_DEF_COM WHERE COM_ID=A.COM_ID AND
	RC_STATE='E')"comName",
	H.AGENT_ID "agentId",
  H.AGENT_NAME "agentName",
	A.ORDER_AMOUNT "orderAmount",
  DATE_FORMAT(A.ORDER_DATE,'%Y-%m-%d
	%H:%i:%S') "orderDate",
	A.INVITE_CODE"inviteCode",
	A.PLAN_TRANSFER_DATE "planTransferDate",
	A.ORDER_STATUS "orderStatus",
	FUNC_GET_CODE_NAME('custOrderStatus',A.ORDER_STATUS) "orderStatusName",
	DATE_FORMAT(a.expect_open_day,'%Y-%m-%d ') "expectOpenDay",
	DATE_FORMAT(D.FOUND_DATE,'%Y-%m-%d ') "foundDate",
	DATE_FORMAT(D.RAISE_END_DATE,'%Y-%m-%d ') "investEndDate",
	A.QUEUE_IS_DISTRIBUTE "queueIsDistribute",
  FUNC_GET_CODE_NAME('queueStatus',A.QUEUE_IS_DISTRIBUTE) "queueIsDistributeName"
	FROM t_pd_amount_order_queue_info A,T_PD_PRODUCT B,T_AGENCY_COM C,T_PD_WEALTH
	D,T_AGENT H
	WHERE A.PRODUCT_ID = B.PRODUCT_ID
	AND B.AGENCY_COM_ID =C.AGENCY_COM_ID
	AND B.PRODUCT_ID = D.PRODUCT_ID
	AND A.AGENT_ID = H.AGENT_ID
	AND B.STATUS = '2'
	AND A.RC_STATE = 'E'
	AND B.RC_STATE = 'E'
	AND C.RC_STATE = 'E'
	AND D.RC_STATE = 'E'
	AND H.RC_STATE = 'E'
	AND case
	when B.PRODUCT_SUB_TYPE='01' OR B.PRODUCT_SUB_TYPE='02'
	THEN
CURRENT_TIMESTAMP <![CDATA[>=]]>
	(SELECT
	MAX(X.RAISE_START_DATE)
	FROM
	t_pd_wealth X
	WHERE
	X.PRODUCT_ID = B.PRODUCT_ID
	AND x.RC_STATE = "E"
	)
	AND CURRENT_TIMESTAMP <![CDATA[<=]]>
	(SELECT
	DATE_ADD(MAX(X.RAISE_END_DATE),INTERVAL 2 DAY)
	FROM
	t_pd_wealth X
	WHERE
	X.PRODUCT_ID = B.PRODUCT_ID
	AND x.RC_STATE = "E"
	)
	ELSE EXISTS(SELECT 'X' FROM t_pd_wealth
	X,t_pd_wealth_open_date Y
	WHERE
	X.PRODUCT_ID=B.PRODUCT_ID
	AND
	X.PD_WEALTH_ID = Y.PD_WEALTH_ID
	AND
	CURRENT_TIMESTAMP <![CDATA[>=]]>
	Y.INVEST_START_DATE
	AND CURRENT_TIMESTAMP <![CDATA[<=]]>
	DATE_ADD(a.expect_open_day,INTERVAL 2 DAY))
	END
<include refid="productOrderQueueInfo" />
ORDER BY
					b.PRODUCT_ID , A.QUEUE_NO)t,
				(select @rowNum := 0) T2
				ORDER BY serialNo
LIMIT #{startIndex} , #{endIndex} 
	</select>

	<select id="getRemainAmountOrderInfoCount" parameterType="java.util.Map"
		resultType="java.lang.Integer">
	SELECT COUNT(1)
	FROM t_pd_amount_order_queue_info A,T_PD_PRODUCT B,T_AGENCY_COM C,T_PD_WEALTH
	D,T_AGENT H
	WHERE A.PRODUCT_ID = B.PRODUCT_ID
	AND B.AGENCY_COM_ID =C.AGENCY_COM_ID
	AND B.PRODUCT_ID = D.PRODUCT_ID
	AND A.AGENT_ID = H.AGENT_ID
	AND B.STATUS = '2'
	AND A.RC_STATE = 'E'
	AND B.RC_STATE = 'E'
	AND C.RC_STATE = 'E'
	AND D.RC_STATE = 'E'
	AND H.RC_STATE = 'E'
	 <include refid="productOrderQueueInfo" />
	AND case
	when B.PRODUCT_SUB_TYPE='01' OR B.PRODUCT_SUB_TYPE='02'
	THEN
CURRENT_TIMESTAMP <![CDATA[>=]]>
	(SELECT
	MAX(X.RAISE_START_DATE)
	FROM
	t_pd_wealth X
	WHERE
	X.PRODUCT_ID = B.PRODUCT_ID
	AND x.RC_STATE = "E"
	)
	AND CURRENT_TIMESTAMP <![CDATA[<=]]>
	(SELECT
	DATE_ADD(MAX(X.RAISE_END_DATE),INTERVAL 2 DAY)
	FROM
	t_pd_wealth X
	WHERE
	X.PRODUCT_ID = B.PRODUCT_ID
	AND x.RC_STATE = "E"
	)
	ELSE EXISTS(SELECT 'X' FROM t_pd_wealth
	X,t_pd_wealth_open_date Y
	WHERE
	X.PRODUCT_ID=B.PRODUCT_ID
	AND
	X.PD_WEALTH_ID = Y.PD_WEALTH_ID
	AND
	CURRENT_TIMESTAMP <![CDATA[>=]]>
	Y.INVEST_START_DATE
	AND CURRENT_TIMESTAMP <![CDATA[<=]]>
	DATE_ADD(a.expect_open_day,INTERVAL 2 DAY))
	END
			 
	</select>
	
	<!-- 产品预约排队数据导出  -->
	<select id="queryProductOrderQueueDetailList" parameterType="java.util.Map"
		resultType="java.util.Map">
	SELECT
					(@rowNum:=@rowNum+1) as "serialNo",
					t.*
					FROM(SELECT
	A.PD_AMOUNT_ORDER_QUEUE_INFO_ID "pdAmountOrderQueueInfoId",
  A.PRODUCT_ID "productId",
  A.QUEUE_NO "queueNo",
	B.PRODUCT_NAME "productName",
  B.PRODUCT_TYPE "productType",
  B.PRODUCT_SUB_TYPE "productSubType",
  B.REMARK "remark",
	C.AGENCY_COM_ID "agencyComId",
  C.AGENCY_NAME "agencyName",
  A.CUST_NAME"custName",
  IFNULL(A.CUST_BASE_INFO_ID,"") "custBaseInfoId",
	A.COM_ID "comId",
  (SELECT COM_NAME FROM T_DEF_COM WHERE COM_ID=A.COM_ID AND
	RC_STATE='E')"comName",
	H.AGENT_ID "agentId",
  H.AGENT_NAME "agentName",
	A.ORDER_AMOUNT "orderAmount",
  DATE_FORMAT(A.ORDER_DATE,'%Y-%m-%d %H:%i:%S') "orderDate",
	A.INVITE_CODE"inviteCode",
	A.PLAN_TRANSFER_DATE "planTransferDate",
	A.ORDER_STATUS "orderStatus",
	FUNC_GET_CODE_NAME('custOrderStatus',A.ORDER_STATUS) "orderStatusName",
	DATE_FORMAT(a.expect_open_day,'%Y-%m-%d ') "expectOpenDay",
	DATE_FORMAT(D.FOUND_DATE,'%Y-%m-%d ') "foundDate",
	DATE_FORMAT(D.RAISE_END_DATE,'%Y-%m-%d ') "investEndDate",
	A.QUEUE_IS_DISTRIBUTE "queueIsDistribute",
  FUNC_GET_CODE_NAME('queueStatus',A.QUEUE_IS_DISTRIBUTE) "queueIsDistributeName",
CASE A.IS_OLD_CUSTOMER WHEN '01' THEN '是' ELSE '否' END "isNewCustomer"
	FROM t_pd_amount_order_queue_info A,T_PD_PRODUCT B,T_AGENCY_COM C,T_PD_WEALTH
	D,T_AGENT H
	WHERE A.PRODUCT_ID = B.PRODUCT_ID
	AND B.AGENCY_COM_ID =C.AGENCY_COM_ID
	AND B.PRODUCT_ID = D.PRODUCT_ID
	AND A.AGENT_ID = H.AGENT_ID
	AND B.STATUS = '2'
	AND A.RC_STATE = 'E'
	AND B.RC_STATE = 'E'
	AND C.RC_STATE = 'E'
	AND D.RC_STATE = 'E'
	AND H.RC_STATE = 'E'
	AND case
	when B.PRODUCT_SUB_TYPE='01' OR B.PRODUCT_SUB_TYPE='02'
	THEN
CURRENT_TIMESTAMP <![CDATA[>=]]>
	(SELECT
	MAX(X.RAISE_START_DATE)
	FROM
	t_pd_wealth X
	WHERE
	X.PRODUCT_ID = B.PRODUCT_ID
	AND x.RC_STATE = "E"
	)
	AND CURRENT_TIMESTAMP <![CDATA[<=]]>
	(SELECT
	DATE_ADD(MAX(X.RAISE_END_DATE),INTERVAL 2 DAY)
	FROM
	t_pd_wealth X
	WHERE
	X.PRODUCT_ID = B.PRODUCT_ID
	AND x.RC_STATE = "E"
	)
	ELSE EXISTS(SELECT 'X' FROM t_pd_wealth
	X,t_pd_wealth_open_date Y
	WHERE
	X.PRODUCT_ID=B.PRODUCT_ID
	AND
	X.PD_WEALTH_ID = Y.PD_WEALTH_ID
	AND
	CURRENT_TIMESTAMP <![CDATA[>=]]>
	Y.INVEST_START_DATE
	AND CURRENT_TIMESTAMP <![CDATA[<=]]>
	DATE_ADD(a.expect_open_day,INTERVAL 2 DAY))
	END
<include refid="productOrderQueueInfo" />
ORDER BY
					b.PRODUCT_ID , A.QUEUE_NO)t,
				(select @rowNum := 0) T2
				ORDER BY serialNo
	</select>
	
	<!-- 产品预约查询数据导出 -->
	<select id="exportPdOrderQueryInfo" parameterType="java.util.Map" resultType="java.util.Map">
	
	  <!--s-->
	  	SELECT
					(@rowNum:=@rowNum+1) as "serialNo",
					t.*
					FROM(
		SELECT IFNULL(A.CUST_BASE_INFO_ID,"") "custBaseInfoId", A.PD_AMOUNT_ORDER_INFO_ID "pdAmountOrderInfoId",A.PRODUCT_ID "productId",B.REMARK "remark",
            B.PRODUCT_NAME "productName",B.PRODUCT_TYPE "productType",B.PRODUCT_SUB_TYPE "productSubType",
            C.AGENCY_COM_ID"agencyComId",C.AGENCY_NAME "agencyComName",A.CUST_NAME"custName",
            A.COM_ID "comId",(SELECT COM_NAME FROM T_DEF_COM WHERE COM_ID=A.COM_ID AND RC_STATE='E')"comName",
            (
               <!--  SELECT I.MANAGER_NAME FROM T_DEF_DEPARTMENT I WHERE I.DEPARTMENT_ID = H.DEPARTMENT_ID AND I.RC_STATE = 'E' -->
               <!--获取团队长  -->
               SELECT DISTINCT
			   d.agentName
		       FROM
			   t_def_department e,
			   (
				SELECT
					a.department_id department,
					max(b.agent_name) agentName
				FROM
					t_agent_department a,
					t_agent b
				WHERE
					a.agent_id = b.agent_id
				AND b.rc_state = 'E'
				AND a.rc_state = 'E'
				AND a.isleader = 'Y'
				GROUP BY
					a.department_id
			   ) d
		    WHERE
			H.rc_state = 'E'
		    AND d.department = H.department_id
		    AND e.department_id = H.department_id
		    AND e.rc_state = 'E'
           
            )"managerName",
            H.AGENT_ID "agentId",H.AGENT_NAME "agentName",H.STORE_ID "storeId",
            <!-- (SELECT G.STORE_NAME FROM T_DEF_STORE G WHERE G.STORE_ID = H.STORE_ID AND G.RC_STATE = 'E')"storeName", -->
            A.ORDER_AMOUNT "orderAmount",DATE_FORMAT(A.CREATE_DATE,'%Y-%m-%d')"orderDate",
            A.INVITE_CODE "inviteCode",
            FUNC_GET_CODE_NAME('custOrderStatus',A.ORDER_STATUS)"orderStatus",
            DATE_FORMAT(a.expect_open_day,'%Y-%m-%d') "expectOpenDay",
            DATE_FORMAT(D.FOUND_DATE,'%Y-%m-%d') "foundDate",
            DATE_FORMAT(D.RAISE_END_DATE,'%Y-%m-%d') "investEndDate",
            DATE_FORMAT(A.PLAN_TRANSFER_DATE,'%Y-%m-%d') "planTransferDate",
            (CASE WHEN (SELECT COUNT(1) FROM T_PD_AMOUNT_DIS_INFO E WHERE E.PRODUCT_ID = A.PRODUCT_ID 
                                 AND E.COM_ID = A.COM_ID AND E.EXPECT_OPEN_DAY = A.EXPECT_OPEN_DAY 
                                 AND E.RC_STATE = 'E')>0
                    THEN 'Y' ELSE 'N' END) "isDistribute",
                    (
		CASE
		WHEN a.ORDER_STATUS = '02' THEN
			DATE_FORMAT(
				A.MODIFY_DATE,
				'%Y-%m-%d'
			)
		ELSE
			""
		END
	) "auditDate",DATE_FORMAT(A.EARNEST_AUDIT_DATE ,'%Y-%m-%d') "earnestaAuditDate",
			FUNC_GET_CODE_NAME('isOldCustomer',A.IS_OLD_CUSTOMER) "isOldCustomer"
          FROM T_PD_AMOUNT_ORDER_INFO A,T_PD_PRODUCT B,T_AGENCY_COM C,T_PD_WEALTH D,T_AGENT H
          WHERE A.PRODUCT_ID = B.PRODUCT_ID
            AND B.AGENCY_COM_ID =C.AGENCY_COM_ID
            AND B.PRODUCT_ID = D.PRODUCT_ID
            AND A.AGENT_ID = H.AGENT_ID
            AND B.STATUS = '2'
            AND A.RC_STATE = 'E'
            AND B.RC_STATE = 'E'
            AND C.RC_STATE = 'E'
            AND D.RC_STATE = 'E'
            AND H.RC_STATE = 'E'
          AND case
	when B.PRODUCT_SUB_TYPE='01' OR B.PRODUCT_SUB_TYPE='02'
	THEN
	CURRENT_TIMESTAMP <![CDATA[>=]]> D.RAISE_START_DATE
	AND CURRENT_TIMESTAMP <![CDATA[<=]]> DATE_ADD(D.RAISE_END_DATE,INTERVAL 2 DAY)
	ELSE 
	EXISTS(SELECT 'X' FROM t_pd_wealth
	X,t_pd_wealth_open_date Y
	WHERE X.PRODUCT_ID=B.PRODUCT_ID
	AND
	X.PD_WEALTH_ID = Y.PD_WEALTH_ID
	AND CURRENT_TIMESTAMP <![CDATA[>=]]>
	Y.INVEST_START_DATE
	AND CURRENT_TIMESTAMP <![CDATA[<=]]>
	DATE_ADD(a.expect_open_day,INTERVAL 2 DAY))
	END
			<include refid="productAmountOrderInfo" />
			)t,
				(select @rowNum := 0) T2
				ORDER BY serialNo
	</select>
	
	<select id="getPdOrderTotalAmount" parameterType="java.util.Map" resultType="java.math.BigDecimal">
	
	  <!--s-->

	SELECT IFNULL(SUM(A.ORDER_AMOUNT),0)
	FROM T_PD_AMOUNT_ORDER_INFO A,T_PD_PRODUCT B,T_AGENCY_COM C,T_PD_WEALTH
	D,T_AGENT H
	WHERE A.PRODUCT_ID = B.PRODUCT_ID
	AND B.AGENCY_COM_ID =C.AGENCY_COM_ID
	AND B.PRODUCT_ID = D.PRODUCT_ID
	AND A.AGENT_ID = H.AGENT_ID
	AND A.ORDER_STATUS != '03'
	AND B.STATUS = '2'
	AND CASE
	WHEN B.PRODUCT_SUB_TYPE = '01' OR B.PRODUCT_SUB_TYPE = '02'
	THEN EXISTS(SELECT 'X' FROM t_pd_wealth X
	WHERE X.PRODUCT_ID = B.PRODUCT_ID
	AND CURRENT_TIMESTAMP() <![CDATA[>=]]> X.RAISE_START_DATE
	AND CURRENT_TIMESTAMP() <![CDATA[<=]]> X.RAISE_END_DATE)
	ELSE EXISTS(SELECT 'X' FROM t_pd_wealth X , t_pd_wealth_open_date Y
	WHERE X.PRODUCT_ID = B.PRODUCT_ID
	AND X.PD_WEALTH_ID = Y.PD_WEALTH_ID
	AND CURRENT_TIMESTAMP() <![CDATA[>=]]> Y.INVEST_START_DATE
	AND CURRENT_TIMESTAMP() <![CDATA[<=]]> DATE_ADD(a.expect_open_day,INTERVAL 2 DAY))
	END
	AND A.RC_STATE = 'E'
	AND B.RC_STATE = 'E'
	AND C.RC_STATE = 'E'
	AND D.RC_STATE = 'E'
	AND H.RC_STATE = 'E'
			<include refid="productAmountOrderInfo" />
	</select>
	
	<!-- 产品预约审核查询条件 -->
	<sql id="queryComPdAmountOrderAuditInfoCondition">
		<if test='agencyComId != null and agencyComId != ""'>
			AND F.AGENCY_COM_ID = #{agencyComId}
		</if>
		<if test='productId != null and productId != "" '>
			AND B.PRODUCT_ID = #{productId}
		</if>
		<if test=' expectOpenStartDay != null and expectOpenStartDay !="" '>
		 and  A.EXPECT_OPEN_DAY >=STR_TO_DATE(#{expectOpenStartDay},'%Y-%m-%d')
		</if>
		<if test=' expectOpenEndDay !=null and expectOpenEndDay !="" '>
		 and STR_TO_DATE(#{expectOpenEndDay},'%Y-%m-%d')>= A.EXPECT_OPEN_DAY
		</if>
		
		<if test=' comId != null and comId != "" '>
			AND A.COM_ID = #{comId}
		</if>
		<if test=' agentName != null and agentName != "" '>
			AND D.AGENT_ID = #{agentName}
		</if>
		<if test=' custName != null and custName != "" '>
			AND A.CUST_NAME LIKE '%${custName}%' 
		</if>
		
		<if test=' orderStatus != null and orderStatus !="" '>
			AND A.ORDER_STATUS = #{orderStatus}
		</if>
		<if test=' orderStartDate != null and orderStartDate !="" '>
		 and  A.CREATE_DATE >=STR_TO_DATE(#{orderStartDate},'%Y-%m-%d')
		</if>
		<if test=' orderEndDate !=null and orderEndDate !="" '>
		 and STR_TO_DATE(#{orderEndDate},'%Y-%m-%d')>= A.CREATE_DATE
		</if>
		<if test=' auditStartDate != null and auditStartDate !="" '>
		 and   A.MODIFY_DATE>=STR_TO_DATE(#{auditStartDate},'%Y-%m-%d')
		</if>
		<if test=' auditEndDate !=null and auditEndDate !="" '>
		 and STR_TO_DATE(#{auditEndDate},'%Y-%m-%d')>= A.MODIFY_DATE 
		</if>
		
			<!-- 以下是查询权限控制 3-本机构及下属机构数据，2-本机构数据，1-本人数据 -->
		<if
			test='rolePrivilege!=null and rolePrivilege!=null and rolePrivilege=="1"'> 
			and a.agent_id in (select x.agent_id
			from t_agent x
			where x.user_id = #{createUserId}
			and x.rc_state = 'E')
		</if>
		<if
			test='rolePrivilege!=null and rolePrivilege!=null and rolePrivilege=="2" '>
           and a.agent_id in (select x.agent_id
                              from t_agent x
                                where x.com_id = #{operComId}
                                  and x.rc_state = 'E')
		</if>
		<if
			test='rolePrivilege!=null and rolePrivilege!=null and rolePrivilege=="3" '>
			
	 <!--S-->
			 
           and a.agent_id in (select x.agent_id
                 from t_agent x
                where x.com_id in 
                      (<!-- SELECT Y.COM_ID
                         FROM T_DEF_COM Y
                        WHERE Y.RC_STATE = 'E'
                          AND Y.STATE = '01'
                        START WITH Y.COM_ID = #{operComId}
                       CONNECT BY PRIOR Y.COM_ID = Y.PARENT_COM_ID -->
                       select Y.COM_ID from t_def_com Y 
						where Y.RC_STATE = 'E'
                          AND Y.STATE = '01'
						AND FIND_IN_SET(Y.COM_ID, queryChildrenNodeInfo(#{operComId}))
                       
                       )
                  and x.rc_state = 'E')
		</if>
		<!-- 权限控制结束 -->
		
	</sql>
	<!-- 产品预约审核查询 -->
	<select id="queryComPdOrderAuditInfoCount" parameterType="java.util.Map" resultType="java.lang.Integer">
	SELECT count(1)
	FROM T_PD_AMOUNT_ORDER_INFO A,
	T_PD_PRODUCT B,
	T_DEF_COM C,
	T_AGENT D,
	T_AGENCY_COM F
	WHERE 
	A.PRODUCT_ID = B.PRODUCT_ID
	AND A.COM_ID = C.COM_ID
	AND A.AGENT_ID = D.AGENT_ID
	and B.Agency_Com_Id=f.agency_com_id
	AND B.STATUS = '2'
	and f.rc_state='E'
	<include refid="queryComPdAmountOrderAuditInfoCondition" />
	AND A.RC_STATE = 'E'
	AND B.RC_STATE = 'E'
	AND C.RC_STATE = 'E'
	AND case
	when B.PRODUCT_SUB_TYPE='01' OR B.PRODUCT_SUB_TYPE='02'
	THEN
CURRENT_TIMESTAMP <![CDATA[>=]]> (SELECT
MAX(X.RAISE_START_DATE)
 FROM
t_pd_wealth X
WHERE 
X.PRODUCT_ID = B.PRODUCT_ID
AND x.RC_STATE = "E"
)
	AND CURRENT_TIMESTAMP <![CDATA[<=]]>
(SELECT
DATE_ADD(MAX(X.RAISE_END_DATE),INTERVAL 2 DAY)
 FROM
t_pd_wealth X
WHERE 
X.PRODUCT_ID = B.PRODUCT_ID
AND x.RC_STATE = "E"
)
	ELSE EXISTS(SELECT 'X' FROM t_pd_wealth
	X,t_pd_wealth_open_date Y
	WHERE X.PRODUCT_ID=B.PRODUCT_ID
	AND
	X.PD_WEALTH_ID = Y.PD_WEALTH_ID
	AND CURRENT_TIMESTAMP <![CDATA[>=]]>
	Y.INVEST_START_DATE
	AND CURRENT_TIMESTAMP <![CDATA[<=]]>
	DATE_ADD(a.expect_open_day,INTERVAL 2 DAY))
	END
	</select>
	
	<select id="queryComPdOrderAuditInfo" parameterType="java.util.Map" resultType="java.util.Map">
	
	  <!--s-->
	select tAlias.*
	from (select nAlias.*,@rownum:=@rownum+1 r_rownum
	from
	(
	SELECT (SELECT @rownum := 0),
	A.TRADE_INFO_ID 'tradeInfoId',
	A.PD_AMOUNT_ORDER_INFO_ID "pdAmountOrderInfoId",
	F.AGENCY_NAME "agencyComName",
	B.PRODUCT_ID "productId",
	B.PRODUCT_NAME "productName",
	B.REMARK "remark",
	DATE_FORMAT(A.EXPECT_OPEN_DAY, '%Y-%m-%d') "expectOpenDay",
	C.COM_NAME "comName",
	C.COM_ID "comId",
	<!-- (SELECT STORE_NAME FROM T_DEF_STORE G WHERE G.STORE_ID = D.STORE_ID 
		AND G.RC_STATE = 'E')"storeName", -->
	D.AGENT_NAME "agentName",
	A.CUST_NAME "custName",
	A.ORDER_AMOUNT "orderAmount",
	FUNC_GET_CODE_NAME('custOrderStatus',a.order_status) "orderStatusName",
	DATE_FORMAT(A.create_Date,'%Y-%m-%d') "orderDate",
	A.PLAN_TRANSFER_DATE "planTransferDate",
	A.ORDER_STATUS "orderStatus",
	(
	case when a.ORDER_STATUS in ('02','05') THEN
	DATE_FORMAT(A.EARNEST_AUDIT_DATE ,'%Y-%m-%d')
	else ""
	END
	)"earnestAuditDate",
	(
	case when a.ORDER_STATUS='02' THEN
	DATE_FORMAT(A.MODIFY_DATE ,'%Y-%m-%d')
	else ""
	END
	)"auditDate",
	E.FOUND_DATE 'foundDate',
   B.PRODUCT_TYPE 'productType',
   B.PRODUCT_SUB_TYPE 'productSubType',
   E.RAISE_END_DATE 'investEndDate',
   A.INVITE_CODE 'inviteCode',
   (CASE WHEN (SELECT COUNT(1) FROM T_PD_AMOUNT_DIS_INFO E WHERE E.PRODUCT_ID =
	A.PRODUCT_ID
	AND E.COM_ID = A.COM_ID AND E.EXPECT_OPEN_DAY = A.EXPECT_OPEN_DAY
	AND E.RC_STATE = 'E')>0
	THEN 'Y' ELSE 'N' END) 'isDistribute',
	(
		SELECT
			G.TRADE_STAUS
		FROM
			t_trade_info G
		WHERE
			1 = 1
		AND G.TRADE_INFO_ID = A.TRADE_INFO_ID
		AND G.RC_STATE = 'E'
	)  'tradeStaus'
	FROM T_PD_AMOUNT_ORDER_INFO A,
	T_PD_PRODUCT B,
	T_DEF_COM C,
	T_AGENT D,
	T_AGENCY_COM F,
    t_pd_wealth E
	WHERE A.PRODUCT_ID = B.PRODUCT_ID
	AND A.COM_ID = C.COM_ID
	AND A.AGENT_ID = D.AGENT_ID
	and B.Agency_Com_Id=f.agency_com_id
	AND E.PRODUCT_ID = B.PRODUCT_ID
	AND B.STATUS = '2'
	and f.rc_state='E'
	<include refid="queryComPdAmountOrderAuditInfoCondition" />
	AND A.RC_STATE = 'E'
	AND B.RC_STATE = 'E'
	AND C.RC_STATE = 'E'
	AND E.RC_STATE = 'E'
	AND case
	when B.PRODUCT_SUB_TYPE='01' OR B.PRODUCT_SUB_TYPE='02'
	THEN 
	CURRENT_TIMESTAMP <![CDATA[>=]]> (SELECT
MAX(X.RAISE_START_DATE)
 FROM
t_pd_wealth X
WHERE 
X.PRODUCT_ID = B.PRODUCT_ID
AND x.RC_STATE = "E"
)
	AND CURRENT_TIMESTAMP <![CDATA[<=]]>
(SELECT
DATE_ADD(MAX(X.RAISE_END_DATE),INTERVAL 2 DAY)
 FROM
t_pd_wealth X
WHERE 
X.PRODUCT_ID = B.PRODUCT_ID
AND x.RC_STATE = "E"
)
	ELSE EXISTS(SELECT 'X' FROM t_pd_wealth X,t_pd_wealth_open_date Y
	WHERE X.PRODUCT_ID=B.PRODUCT_ID
	AND X.PD_WEALTH_ID = Y.PD_WEALTH_ID
	AND CURRENT_TIMESTAMP <![CDATA[>=]]> Y.INVEST_START_DATE
	AND CURRENT_TIMESTAMP <![CDATA[<=]]> DATE_ADD(a.expect_open_day,INTERVAL 2 DAY))
	END
	) nAlias) tAlias
	where r_rownum >=
	#{startIndex}
	and #{endIndex} >= r_rownum 
	</select>
	
	<!-- 产品预约审核导出查询条件 -->
	<sql id="queryComPdAmountOrderAuditInfo">
		<if test='agencyComId != null and agencyComId != ""'>
			AND C.AGENCY_COM_ID = #{agencyComId}
		</if>
		<if test='productId != null and productId != "" '>
			AND B.PRODUCT_ID = #{productId}
		</if>
		<if test='orderAmount != null and orderAmount != ""'>
			AND A.ORDER_AMOUNT = #{orderAmount}
		</if>
		<if test=' custName != null and custName != "" '>
			AND A.CUST_NAME LIKE '%${custName}%' 
		</if>
		<if test=' agentName != null and agentName != "" '>
			AND D.AGENT_NAME LIKE '%${agentName}%'
		</if>
		<if test=' comId != null and comId != "" '>
			AND E.COM_ID = #{comId}
		</if>
		<if test=' expectOpenDay != null and expectOpenDay !="" '>
		 and DATE_FORMAT(a.expect_open_day,'%Y-%m-%d') >= #{expectOpenStartDay}
		</if>
		<if test=' expectOpenDay != null and expectOpenDay !="" '>
		 and  #{expectOpenEndDay} >= DATE_FORMAT(a.expect_open_day,'%Y-%m-%d')#{expectOpenEndDay}
		</if>
		<if test='orderDate !=null and orderDate !="" '>
		 and DATE_FORMAT(A.CREATE_DATE,'%Y-%m-%d %H:%i:%S') >= #{orderStartDate}
		</if>
		<if test='orderDate !=null and orderDate !="" '>
		 and #{orderEndDate} >= DATE_FORMAT(A.CREATE_DATE,'%Y-%m-%d %H:%i:%S')
		</if>
		<if test=' orderStatus != null and orderStatus != "" '>
			AND A.ORDER_STATUS =#{orderStatus}
		</if>
		<if test=' auditStartDate != null and auditStartDate !="" '>
		 and A.MODIFY_DATE>=STR_TO_DATE(#{auditStartDate},'%Y-%m-%d %H:%i:%S')
		</if>
		<if test=' auditEndDate !=null and auditEndDate !="" '>
		 and STR_TO_DATE(#{auditEndDate},'%Y-%m-%d %H:%i:%S')>= A.MODIFY_DATE 
		</if>
		</sql>
	
	<!--产品预约审核-数据导出 -->
	<select id="getProductOrderDetailInfo" parameterType="java.util.Map" resultType="java.util.Map">
	
	  <!--s-->
	   SELECT
					(@rowNum:=@rowNum+1) as "serialNo",
					t.*
					FROM(
		SELECT
		        B.PRODUCT_NAME "productName",
		        B.REMARK "remark",
		        F.AGENCY_NAME "agencyComName",
		        (
		         <!--  SELECT H.MANAGER_NAME FROM T_DEF_DEPARTMENT H WHERE H.DEPARTMENT_ID = D.DEPARTMENT_ID AND H.RC_STATE = 'E' -->
		         <!-- 获取团队长姓名 -->
		         SELECT DISTINCT
	                d.agentName
                    FROM
	                t_def_department e,
	                (
		             SELECT
			         a.department_id department,
			         max(b.agent_name) agentName
		             FROM
			         t_agent_department a,
			         t_agent b
		             WHERE
			         a.agent_id = b.agent_id
		             AND b.rc_state = 'E'
		             AND a.rc_state = 'E'
		             AND a.isleader = 'Y'
		             GROUP BY
			         a.department_id
	                 ) d
                WHERE
	            D.rc_state = 'E'
                AND d.department =D.department_id
                AND e.department_id = D.department_id
                AND e.rc_state = 'E' 
		        )"managerName",
		       <!--  (SELECT STORE_NAME FROM T_DEF_STORE G WHERE G.STORE_ID = D.STORE_ID AND G.RC_STATE = 'E')"storeName", -->
		        A.CUST_NAME "custName",
		        IFNULL(A.CUST_BASE_INFO_ID,"") "custBaseInfoId",
		        A.ORDER_AMOUNT "orderAmount",
		        DATE_FORMAT(A.CREATE_DATE,'%Y-%m-%d') "orderDate",
		        DATE_FORMAT(A.PLAN_TRANSFER_DATE,'%Y-%m-%d') "planTransferDate",
		        FUNC_GET_CODE_NAME('custOrderStatus',A.ORDER_STATUS) "orderStatus",
		        DATE_FORMAT(a.expect_open_day,'%Y-%m-%d') "expectOpenDay",
		        C.COM_NAME "comName",
		        D.AGENT_NAME "agentName",
		        (
                        case when a.ORDER_STATUS='02' THEN 
                          DATE_FORMAT(A.MODIFY_DATE ,'%Y-%m-%d') 
                         else ""
                         END
                 )"auditDate",
                 DATE_FORMAT(A.EARNEST_AUDIT_DATE ,'%Y-%m-%d') "earnestaAuditDate",
                 FUNC_GET_CODE_NAME('isOldCustomer',A.IS_OLD_CUSTOMER) "isOldCustomer"
	      FROM T_PD_AMOUNT_ORDER_INFO A, T_PD_PRODUCT B,T_AGENCY_COM F,T_AGENT D,T_DEF_COM C
	      WHERE A.PRODUCT_ID = B.PRODUCT_ID
		        AND B.AGENCY_COM_ID =F.AGENCY_COM_ID
		        AND A.AGENT_ID = D.AGENT_ID
		        AND A.COM_ID = C.COM_ID
		        AND B.STATUS = '2'
		        AND A.RC_STATE = 'E'
		        AND B.RC_STATE = 'E'
		        AND F.RC_STATE = 'E'
		        AND D.RC_STATE = 'E'
		        AND C.RC_STATE = 'E'
		        AND case
				when B.PRODUCT_SUB_TYPE='01' OR B.PRODUCT_SUB_TYPE='02'
				THEN 
				CURRENT_TIMESTAMP <![CDATA[>=]]> (SELECT
				MAX(X.RAISE_START_DATE)
 				FROM
				t_pd_wealth X
				WHERE 
				X.PRODUCT_ID = B.PRODUCT_ID
				AND x.RC_STATE = "E"
				)
				AND CURRENT_TIMESTAMP <![CDATA[<=]]>
				(SELECT
				DATE_ADD(MAX(X.RAISE_END_DATE),INTERVAL 2 DAY)
 				FROM
				t_pd_wealth X
				WHERE 
				X.PRODUCT_ID = B.PRODUCT_ID
				AND x.RC_STATE = "E"
				)
				ELSE EXISTS(SELECT 'X' FROM t_pd_wealth X,t_pd_wealth_open_date Y
				WHERE X.PRODUCT_ID=B.PRODUCT_ID
				AND X.PD_WEALTH_ID = Y.PD_WEALTH_ID
				AND CURRENT_TIMESTAMP <![CDATA[>=]]> Y.INVEST_START_DATE
				AND CURRENT_TIMESTAMP <![CDATA[<=]]> DATE_ADD(a.expect_open_day,INTERVAL 2 DAY))
				END
		        <include refid="queryComPdAmountOrderAuditInfoCondition" />
		        )t,
				(select @rowNum := 0) T2
				ORDER BY serialNo
				<!-- <include refid="queryComPdAmountOrderAuditInfo" /> -->
	</select>
	
	
	
	<select id="getPdOrderAuditOrderTotalAmount" parameterType="java.util.Map" resultType="java.math.BigDecimal">
	
	  <!--s-->

	SELECT IFNULL(SUM(A.ORDER_AMOUNT),0)
	FROM T_PD_AMOUNT_ORDER_INFO A,
	T_PD_PRODUCT B,T_AGENCY_COM C,T_AGENT D,T_DEF_COM E
	WHERE A.PRODUCT_ID = B.PRODUCT_ID
	AND B.AGENCY_COM_ID =C.AGENCY_COM_ID
	AND A.AGENT_ID = D.AGENT_ID
	AND A.COM_ID = E.COM_ID
	AND A.ORDER_STATUS != '03'
	AND B.STATUS = '2'
	AND CASE
	WHEN B.PRODUCT_SUB_TYPE = '01' OR B.PRODUCT_SUB_TYPE = '02'
	THEN EXISTS(SELECT 'X' FROM t_pd_wealth X
	WHERE X.PRODUCT_ID = B.PRODUCT_ID
	AND CURRENT_TIMESTAMP() <![CDATA[>=]]> X.RAISE_START_DATE
	AND CURRENT_TIMESTAMP() <![CDATA[<=]]> X.RAISE_END_DATE)
	ELSE EXISTS(SELECT 'X' FROM t_pd_wealth X , t_pd_wealth_open_date Y
	WHERE X.PRODUCT_ID = B.PRODUCT_ID
	AND X.PD_WEALTH_ID = Y.PD_WEALTH_ID
	AND CURRENT_TIMESTAMP() <![CDATA[>=]]> Y.INVEST_START_DATE
	AND CURRENT_TIMESTAMP() <![CDATA[<=]]> DATE_ADD(a.expect_open_day,INTERVAL 2 DAY))
	END
	AND A.RC_STATE = 'E'
	AND B.RC_STATE = 'E'
	AND C.RC_STATE = 'E'
	AND D.RC_STATE = 'E'
	AND E.RC_STATE = 'E'
		<include refid="queryComPdAmountOrderAuditInfo" />
	</select>
	
	
	<select id="getCustHadBuyWYBProductCount" parameterType="java.util.Map" resultType="java.util.Map">
	
	 <!--S-->
	 
		SELECT DISTINCT C.PRODUCT_NAME "productName",DATE_FORMAT(D.FOUND_DATE,'%Y-%m-%d')"foundDate"
		FROM T_TRADE_INFO A,T_TRADE_PRODUCT_INFO B,T_PD_PRODUCT C,T_PD_WEALTH D,T_TRADE_CUST_INFO E
		WHERE A.TRADE_INFO_ID = B.TRADE_INFO_ID
		      AND B.PRODUCT_ID = C.PRODUCT_ID
		      AND C.PRODUCT_ID = D.PRODUCT_ID
		      AND B.TRADE_INFO_ID = E.TRADE_INFO_ID
		      AND E.CUST_BASE_INFO_ID IN(SELECT F.CUST_BASE_INFO_ID 
		                                        FROM T_CUST_BASE_INFO F,T_CUST_CONTACT_INFO G 
		                                        WHERE F.CUST_BASE_INFO_ID = G.CUST_BASE_INFO_ID
		                                        AND F.CHN_NAME = #{custName} 
		                                        AND G.MOBILE = #{custMobile}
		                                        <if test='idNo != null and idNo != "" '>
													AND F.ID_NO = #{idNo}
												</if>
												<if test='idType != null and idType != "" '>
													AND F.ID_TYPE = #{idType}
												</if>
		                                        )
		      AND (C.PRODUCT_NAME LIKE '%物业宝%' OR C.PRODUCT_NAME LIKE '%物业定期宝%')
		      AND TIMESTAMPDIFF(MONTH,D.FOUND_DATE,STR_TO_DATE('${foundDate}','%Y-%m-%d'))<![CDATA[<=]]> 12
		      AND A.TRADE_STAUS = '10'
		      AND C.STATUS = '2'
		      AND A.RC_STATE = 'E'
		      AND B.RC_STATE = 'E'
		      AND C.RC_STATE = 'E'
		      AND D.RC_STATE = 'E'
		      AND E.RC_STATE = 'E'
	
	</select>
	<!-- 获取预约剩余额度 -->
	<select id="getRemainTotalAmount" parameterType="java.util.Map" resultType="java.math.BigDecimal">
	SELECT 
	IFNULL(SUM(A.ORDER_AMOUNT),0) 'remainAmount'
	FROM T_PD_AMOUNT_ORDER_INFO A,T_PD_PRODUCT B,T_AGENCY_COM C,T_PD_WEALTH
	D,T_AGENT H
	WHERE A.PRODUCT_ID = B.PRODUCT_ID
	AND B.AGENCY_COM_ID =C.AGENCY_COM_ID
	AND B.PRODUCT_ID = D.PRODUCT_ID
	AND A.AGENT_ID = H.AGENT_ID
	AND A.ORDER_STATUS NOT IN ('03','04')
	AND B.STATUS = '2'
	AND CASE
	WHEN B.PRODUCT_SUB_TYPE = '01' OR B.PRODUCT_SUB_TYPE = '02'
	THEN EXISTS(SELECT 'X' FROM t_pd_wealth X
	WHERE X.PRODUCT_ID = B.PRODUCT_ID
	AND CURRENT_TIMESTAMP() <![CDATA[>=]]> X.RAISE_START_DATE
	AND CURRENT_TIMESTAMP() <![CDATA[<=]]> X.RAISE_END_DATE)
	ELSE EXISTS(SELECT 'X' FROM t_pd_wealth X , t_pd_wealth_open_date Y
	WHERE X.PRODUCT_ID = B.PRODUCT_ID
	AND X.PD_WEALTH_ID = Y.PD_WEALTH_ID
	AND CURRENT_TIMESTAMP() <![CDATA[>=]]> Y.INVEST_START_DATE
	AND CURRENT_TIMESTAMP() <![CDATA[<=]]> Y.INVEST_END_DATE)
	END
	AND A.RC_STATE = 'E'
	AND B.RC_STATE = 'E'
	AND C.RC_STATE = 'E'
	AND D.RC_STATE = 'E'
	AND H.RC_STATE = 'E'
	<include refid="productAmountOrderInfo" />
			
	</select>
	
	<select id="getProductFinancingScale" parameterType="java.util.Map" resultType="java.math.BigDecimal">
	SELECT 
	IFNULL(SUM(D.FINANCING_SCALE),0) 'financingScale'
	FROM T_PD_PRODUCT B,T_AGENCY_COM C,T_PD_WEALTH
	D
	WHERE 
	    B.AGENCY_COM_ID =C.AGENCY_COM_ID
	AND B.PRODUCT_ID = D.PRODUCT_ID
	AND B.STATUS = '2'
	AND B.IS_ORDER = '01'
	AND CASE
	WHEN B.PRODUCT_SUB_TYPE = '01' OR B.PRODUCT_SUB_TYPE = '02'
	THEN 
	    CURRENT_TIMESTAMP() <![CDATA[>=]]> D.RAISE_START_DATE
	AND CURRENT_TIMESTAMP() <![CDATA[<=]]> D.RAISE_END_DATE
	ELSE EXISTS(SELECT 'X' FROM  t_pd_wealth_open_date Y
	WHERE 
		D.PD_WEALTH_ID = Y.PD_WEALTH_ID
	AND CURRENT_TIMESTAMP() <![CDATA[>=]]> Y.INVEST_START_DATE
	AND CURRENT_TIMESTAMP() <![CDATA[<=]]> Y.INVEST_END_DATE)
	END
	AND B.RC_STATE = 'E'
	AND C.RC_STATE = 'E'
	AND D.RC_STATE = 'E'
	<include refid="productFinancingScaleInfo" />
			
	</select>
	
	<sql id="productFinancingScaleInfo">
		<if test='productId!= null and productId!=""'>
			AND B.PRODUCT_ID = #{productId}
		</if>
	</sql>
	<!-- 产品预约排队查询条件 -->
	<sql id="productOrderQueueInfo">
		<if test='agencyComId!= null and agencyComId!=""'>
			AND C.AGENCY_COM_ID = #{agencyComId}
		</if>
		<if test='productId!= null and productId!=""'>
			AND A.PRODUCT_ID = #{productId}
		</if>
		<if test='custName != null and custName !=""'>
			AND A.CUST_NAME like '%${custName}%'
		</if>
		<if test='comId != null and comId !=""'>
			AND A.COM_ID = #{comId}
		</if>
		<if test='agentId != null and agentId !=""'>
			AND A.agent_id = #{agentId}
		</if>
		<if test='orderStatus!= null and orderStatus!=""'>
			AND A.ORDER_STATUS = #{orderStatus}
		</if>
		<if test='queueIsDistribute!= null and queueIsDistribute!=""'>
			AND A.QUEUE_IS_DISTRIBUTE = #{queueIsDistribute}
		</if>
		<if test=' orderStartDate != null and orderStartDate !="" '>
		 and  A.ORDER_DATE >=STR_TO_DATE(#{orderStartDate},'%Y-%m-%d')
		</if>
		<if test=' orderEndDate !=null and orderEndDate !="" '>
		 and STR_TO_DATE(#{orderEndDate},'%Y-%m-%d')>= A.ORDER_DATE
		</if>
		<!-- 以下是查询权限控制 3-本机构及下属机构数据，2-本机构数据，1-本人数据 -->
		<if
			test='rolePrivilege!=null and rolePrivilege!=null and rolePrivilege=="1"'> 
			and a.agent_id in (select x.agent_id
			from t_agent x
			where x.user_id = #{createUserId}
			and x.rc_state = 'E')
		</if>
		<if
			test='rolePrivilege!=null and rolePrivilege!=null and rolePrivilege=="2" '>
           and a.agent_id in (select x.agent_id
                              from t_agent x
                                where x.com_id = #{operComId}
                                  and x.rc_state = 'E')
		</if>
		<if
			test='rolePrivilege!=null and rolePrivilege!=null and rolePrivilege=="3" '>
			
	 <!--S-->
			 
           and a.agent_id in (select x.agent_id
                 from t_agent x
                where x.com_id in 
                      (<!-- SELECT Y.COM_ID
                         FROM T_DEF_COM Y
                        WHERE Y.RC_STATE = 'E'
                          AND Y.STATE = '01'
                        START WITH Y.COM_ID = #{operComId}
                       CONNECT BY PRIOR Y.COM_ID = Y.PARENT_COM_ID -->
                       select Y.COM_ID from t_def_com Y 
						where Y.RC_STATE = 'E'
                          AND Y.STATE = '01'
						AND FIND_IN_SET(Y.COM_ID, queryChildrenNodeInfo(#{operComId}))
                       
                       )
                  and x.rc_state = 'E')
		</if>
		<!-- 权限控制结束 -->
	</sql>
	
	
	<!-- 热门产品count -->
	<select id="queryHotPdOrderInfoListCount" parameterType="java.util.Map"	resultType="java.lang.Integer">
		
		SELECT SUM(COUNT_) 
		FROM(SELECT COUNT(1) COUNT_
					FROM T_PD_AMOUNT_DIS_INFO A,T_PD_PRODUCT B,T_AGENCY_COM C,T_PD_WEALTH D
			      WHERE A.PRODUCT_ID = B.PRODUCT_ID
				      AND B.AGENCY_COM_ID = C.AGENCY_COM_ID
				      AND B.PRODUCT_ID = D.PRODUCT_ID
				      AND A.COM_ID = #{comId}
				      AND B.STATUS = '2'
				      <include refid="queryComPdAmountOrderInfoCondition"/>
				      AND A.RC_STATE = 'E'
				      AND B.RC_STATE = 'E'
				      AND C.RC_STATE = 'E'
				      AND D.RC_STATE = 'E'
				UNION 
				SELECT COUNT(1) COUNT_
		       FROM T_PD_PRODUCT A,T_AGENCY_COM B,T_PD_WEALTH C
		            WHERE A.PRODUCT_ID = C.PRODUCT_ID
		            AND B.AGENCY_COM_ID = A.AGENCY_COM_ID
		            AND A.PRODUCT_TYPE = '1'
		            AND A.PRODUCT_SUB_TYPE in ('01','02')
		            AND A.IS_ORDER = '01'
		            AND A.STATUS = '2'
		            <include refid="queryComPdAmountOrderInfoCondition"/>
		           <!-- AND STR_TO_DATE('${currentTime}','%Y-%m-%d %H:%i:%S') <![CDATA[<=]]> C.RAISE_END_DATE   --> 
		            <!-- AND TO_DATE('${currentTime}','YYYY-MM-DD HH24:MI:SS') BETWEEN C.RAISE_START_DATE AND C.RAISE_END_DATE -->
		            AND NOT EXISTS(SELECT 'X' FROM T_PD_AMOUNT_DIS_INFO WHERE PRODUCT_ID = A.PRODUCT_ID AND RC_STATE = 'E')
		            AND A.RC_STATE = 'E'
		            AND B.RC_STATE = 'E'
		            AND C.RC_STATE = 'E'
				UNION 
				SELECT COUNT(1) COUNT_
			        FROM T_PD_PRODUCT A,T_AGENCY_COM B,T_PD_WEALTH C,T_PD_WEALTH_OPEN_DATE D
	            WHERE A.PRODUCT_ID = C.PRODUCT_ID
		            AND B.AGENCY_COM_ID = A.AGENCY_COM_ID
		            AND C.PD_WEALTH_ID = D.PD_WEALTH_ID
		            AND A.PRODUCT_TYPE = '1'
		            AND A.PRODUCT_SUB_TYPE in ('03','04')
		            AND A.IS_ORDER = '01'
		            AND A.STATUS = '2'
		            <include refid="queryComPdAmountOrderInfoCondition"/>
		           <!-- AND STR_TO_DATE('${currentTime}','%Y-%m-%d %H:%i:%S') <![CDATA[<=]]> D.INVEST_END_DATE  -->
		            <!-- AND TO_DATE('${currentTime}','YYYY-MM-DD HH24:MI:SS') BETWEEN D.INVEST_START_DATE AND D.INVEST_END_DATE -->
		             AND NOT EXISTS(SELECT 'X' FROM T_PD_AMOUNT_DIS_INFO G WHERE G.PRODUCT_ID = A.PRODUCT_ID 
		                AND G.EXPECT_OPEN_DAY=D.OPEN_DATE AND RC_STATE = 'E')
		            AND A.RC_STATE = 'E'
		            AND B.RC_STATE = 'E'
		            AND C.RC_STATE = 'E'
		            AND D.RC_STATE = 'E' )t
		         
	</select>
	
	<!-- 热门产品列表  -->
	<select id="queryHotPdOrderInfoList" parameterType="java.util.Map"
		resultType="java.util.Map">

		select tAlias.*
		from (select nAlias.*, @rownum:=@rownum+1 r_rownum
		from
		(
		  SELECT (SELECT @rownum := 0),
		         PD_AMOUNT_ORDER_INFO.*,
			     (CASE WHEN investStartDate>'${currentTime}' THEN '01'
			                  WHEN (investStartDate<![CDATA[<=]]>'${currentTime}' 
			                       AND '${currentTime}'<![CDATA[<=]]>investEndDate) THEN '02'
			                  WHEN investEndDate <![CDATA[<]]>'${currentTime}' THEN '03' END) "pdOrderStatus",
			     (CASE WHEN investStartDate<![CDATA[>]]>'${currentTime}' 
			                  THEN FUNC_GET_CODE_NAME('pdOrderStatus','01')
			                  WHEN (investStartDate<![CDATA[<=]]>'${currentTime}' 
			                       AND '${currentTime}'<![CDATA[<=]]>investEndDate) 
			                  THEN FUNC_GET_CODE_NAME('pdOrderStatus','02')
			                  WHEN investEndDate <![CDATA[<]]>'${currentTime}'
			                  THEN FUNC_GET_CODE_NAME('pdOrderStatus','03') END) "pdOrderStatusName"
			FROM    
			    (SELECT A.COM_ID "comId",C.AGENCY_COM_ID "agencyComId",C.AGENCY_NAME "agencyComName",
			             B.PRODUCT_ID "productId",B.PRODUCT_NAME "productName",
			             B.PRODUCT_TYPE "productType",B.PRODUCT_SUB_TYPE "productSubType",B.REMARK "remark",
			             (CASE WHEN B.PRODUCT_TYPE = '1' AND B.PRODUCT_SUB_TYPE  in ('03','04')
			                            THEN DATE_FORMAT(A.EXPECT_OPEN_DAY,'%Y-%m-%d')
		                       WHEN B.PRODUCT_TYPE = '1' AND B.PRODUCT_SUB_TYPE in ('01','02')
			                       		THEN '' END ) "expectOpenDay",
			             DATE_FORMAT(D.FOUND_DATE,'%Y-%m-%d') "foundDate",A.AMOUNT "amount",
			             A.AMOUNT-(SELECT IFNULL(SUM(IFNULL(E.ORDER_AMOUNT,0)),0)  
			                              FROM T_PD_AMOUNT_ORDER_INFO E WHERE E.PRODUCT_ID = B.PRODUCT_ID 
			                                   AND E.COM_ID = A.COM_ID AND E.EXPECT_OPEN_DAY = A.EXPECT_OPEN_DAY
			                                   AND E.ORDER_STATUS IN('01','02') 
			                                   AND E.RC_STATE = 'E') "remainAmount",
			            IFNULL(B.IS_INVITE_CODE,'02') "isInviteCode",
			             FUNC_GET_CODE_NAME('isInviteCode',IFNULL(B.IS_INVITE_CODE,'02'))"isInviteCodeName", 
			             (CASE WHEN B.PRODUCT_TYPE = '1' AND B.PRODUCT_SUB_TYPE in ('03','04')
			                            THEN (SELECT DATE_FORMAT(F.INVEST_START_DATE,'%Y-%m-%d %H:%i:%S') FROM T_PD_WEALTH_OPEN_DATE F 
			                                 WHERE F.PD_WEALTH_ID = D.PD_WEALTH_ID 
			                                 AND F.OPEN_DATE = A.EXPECT_OPEN_DAY AND F.RC_STATE= 'E') 
			                       WHEN B.PRODUCT_TYPE = '1' AND B.PRODUCT_SUB_TYPE in ('01','02')
			                            THEN DATE_FORMAT(D.RAISE_START_DATE,'%Y-%m-%d %H:%i:%S') END ) "investStartDate",
			             (CASE WHEN B.PRODUCT_TYPE = '1' AND B.PRODUCT_SUB_TYPE in ('03','04')
			                      THEN (SELECT DATE_FORMAT(F.INVEST_END_DATE,'%Y-%m-%d %H:%i:%S') FROM T_PD_WEALTH_OPEN_DATE F 
			                           WHERE F.PD_WEALTH_ID = D.PD_WEALTH_ID 
			                           AND F.OPEN_DATE = A.EXPECT_OPEN_DAY AND F.RC_STATE= 'E') 
			                 WHEN B.PRODUCT_TYPE = '1' AND B.PRODUCT_SUB_TYPE in ('01','02')
			                      THEN DATE_FORMAT(D.RAISE_END_DATE,'%Y-%m-%d %H:%i:%S') END ) "investEndDate",
			              'Y' AS "isDistribute" ,	B.is_hot "isHotCode", FUNC_GET_CODE_NAME('productIsHot',B.is_hot) "isHot"
			      FROM T_PD_AMOUNT_DIS_INFO A,T_PD_PRODUCT B,T_AGENCY_COM C,T_PD_WEALTH D
			      WHERE A.PRODUCT_ID = B.PRODUCT_ID
				      AND B.AGENCY_COM_ID = C.AGENCY_COM_ID
				      AND B.PRODUCT_ID = D.PRODUCT_ID
				      AND A.COM_ID = #{comId}
				      AND B.STATUS = '2'
				      <include refid="queryComPdAmountOrderInfoCondition"/>
				      AND A.RC_STATE = 'E'
				      AND B.RC_STATE = 'E'
				      AND C.RC_STATE = 'E'
				      AND D.RC_STATE = 'E'
			      UNION <!-- 固收类可预约未分配额度的所有产品 -->
			      SELECT 0 "comId",B.AGENCY_COM_ID "agencyComId",B.AGENCY_NAME "agencyComName",
	                   A.PRODUCT_ID "productId",A.PRODUCT_NAME "productName",
	                   A.PRODUCT_TYPE "productType",A.PRODUCT_SUB_TYPE "productSubType",A.REMARK "remark",
	                   '' AS "expectOpenDay",
	                   DATE_FORMAT(C.FOUND_DATE,'%Y-%m-%d') "foundDate",C.FINANCING_SCALE "amount",
	                   C.FINANCING_SCALE-(SELECT IFNULL(SUM(IFNULL(E.ORDER_AMOUNT,0)),0)  
	                                    FROM T_PD_AMOUNT_ORDER_INFO E WHERE E.PRODUCT_ID = A.PRODUCT_ID 
	                                         AND E.EXPECT_OPEN_DAY = C.FOUND_DATE
	                                         AND E.ORDER_STATUS IN('01','02') 
	                                         AND E.RC_STATE = 'E') "remainAmount",
	                   IFNULL(A.IS_INVITE_CODE,'02') "isInviteCode",
	                   FUNC_GET_CODE_NAME('isInviteCode',IFNULL(A.IS_INVITE_CODE,'02'))"isInviteCodeName", 
	                   DATE_FORMAT(C.RAISE_START_DATE,'%Y-%m-%d %H:%i:%S') "investStartDate",
	                  DATE_FORMAT(C.RAISE_END_DATE,'%Y-%m-%d %H:%i:%S') "investEndDate",
			           'N' AS "isDistribute",		A.is_hot "isHotCode",
				FUNC_GET_CODE_NAME('productIsHot',A.is_hot) "isHot"
	            FROM T_PD_PRODUCT A,T_AGENCY_COM B,T_PD_WEALTH C
		            WHERE A.PRODUCT_ID = C.PRODUCT_ID
		            AND B.AGENCY_COM_ID = A.AGENCY_COM_ID
		            AND A.PRODUCT_TYPE = '1'
		            AND A.PRODUCT_SUB_TYPE in ('01','02')
		            AND A.IS_ORDER = '01'
		            AND A.STATUS = '2'
		            <include refid="queryComPdAmountOrderInfoCondition"/>
		           <!-- AND STR_TO_DATE('${currentTime}','%Y-%m-%d %H:%i:%S') <![CDATA[<=]]> C.RAISE_END_DATE   --> 
		            <!-- AND TO_DATE('${currentTime}','YYYY-MM-DD HH24:MI:SS') BETWEEN C.RAISE_START_DATE AND C.RAISE_END_DATE -->
		            AND NOT EXISTS(SELECT 'X' FROM T_PD_AMOUNT_DIS_INFO WHERE PRODUCT_ID = A.PRODUCT_ID AND RC_STATE = 'E')
		            AND A.RC_STATE = 'E'
		            AND B.RC_STATE = 'E'
		            AND C.RC_STATE = 'E'
			    UNION <!-- 浮收类可预约但未分配额度的产品 -->
			   SELECT 0 "comId",B.AGENCY_COM_ID "agencyComId",B.AGENCY_NAME "agencyComName",
	                   A.PRODUCT_ID "productId",A.PRODUCT_NAME "productName",
	                   A.PRODUCT_TYPE "productType",A.PRODUCT_SUB_TYPE "productSubType",A.REMARK "remark",
	                   DATE_FORMAT(D.OPEN_DATE,'%Y-%m-%d') "expectOpenDay",
	                   DATE_FORMAT(C.FOUND_DATE,'') "foundDate",D.FINANCING_SCALE "amount",
	                   D.FINANCING_SCALE-(SELECT IFNULL(SUM(IFNULL(E.ORDER_AMOUNT,0)),0)  
	                                    FROM T_PD_AMOUNT_ORDER_INFO E WHERE E.PRODUCT_ID = A.PRODUCT_ID 
	                                         AND E.EXPECT_OPEN_DAY = D.OPEN_DATE
	                                         AND E.ORDER_STATUS IN('01','02') 
	                                         AND E.RC_STATE = 'E') "remainAmount",
	                  IFNULL(A.IS_INVITE_CODE,'02') "isInviteCode",
	                   FUNC_GET_CODE_NAME('isInviteCode',IFNULL(A.IS_INVITE_CODE,'02'))"isInviteCodeName", 
	                   DATE_FORMAT(D.INVEST_START_DATE,'%Y-%m-%d %H:%i:%S') "investStartDate",
	                   DATE_FORMAT(D.INVEST_END_DATE,'%Y-%m-%d %H:%i:%S') "investEndDate",
			           'N' AS "isDistribute",		A.is_hot "isHotCode",
				FUNC_GET_CODE_NAME('productIsHot',A.is_hot) "isHot"
	            FROM T_PD_PRODUCT A,T_AGENCY_COM B,T_PD_WEALTH C,T_PD_WEALTH_OPEN_DATE D
	            WHERE A.PRODUCT_ID = C.PRODUCT_ID
		            AND B.AGENCY_COM_ID = A.AGENCY_COM_ID
		            AND C.PD_WEALTH_ID = D.PD_WEALTH_ID
		            AND A.PRODUCT_TYPE = '1'
		            AND A.PRODUCT_SUB_TYPE in ('03','04')
		            AND A.IS_ORDER = '01'
		            AND A.STATUS = '2'
		            AND '${currentTime}'  >= D.INVEST_START_DATE
			        AND D.INVEST_END_DATE>='${currentTime}' 
		            <include refid="queryComPdAmountOrderInfoCondition"/>
		           <!-- AND STR_TO_DATE('${currentTime}','%Y-%m-%d %H:%i:%S') <![CDATA[<=]]> D.INVEST_END_DATE  -->
		            <!-- AND TO_DATE('${currentTime}','YYYY-MM-DD HH24:MI:SS') BETWEEN D.INVEST_START_DATE AND D.INVEST_END_DATE -->
		             AND NOT EXISTS(SELECT 'X' FROM T_PD_AMOUNT_DIS_INFO G WHERE G.PRODUCT_ID = A.PRODUCT_ID 
		                AND G.EXPECT_OPEN_DAY=D.OPEN_DATE AND RC_STATE = 'E')
		            AND A.RC_STATE = 'E'
		            AND B.RC_STATE = 'E'
		            AND C.RC_STATE = 'E'
		            AND D.RC_STATE = 'E'  
			      ) PD_AMOUNT_ORDER_INFO
	     ) nAlias
	     WHERE 1=1 
	     		AND pdOrderStatus != '03'
	     	<if test='pdOrderStatus != null and pdOrderStatus != ""'>
				AND pdOrderStatus = #{pdOrderStatus}
			</if>
			<include refid="queryComPdAmountOrderInfoCondition1"/>
	     ) tAlias
		where  r_rownum >= #{startIndex} and #{endIndex} >= r_rownum
	</select>
	
	<!--  获取客户信息 -->
	<select id="getCustomerInfo"  parameterType="java.util.Map" resultType="java.util.Map">
		SELECT
a.CUST_BASE_INFO_ID "custBaseInfoId",
a.ID_TYPE "idType",
a.ID_NO "idNo",
a.ID_VALIDITY_DATE "idValidityDate",
CASE WHEN a.CUST_LEVEL = '01' THEN '02'
ELSE '01' END "isOldCustomer",
b.MOBILE "mobile",
b.EMAIL "email"
FROM
t_cust_base_info a,
t_cust_contact_info b
WHERE
a.CUST_BASE_INFO_ID = b.CUST_BASE_INFO_ID
AND a.RC_STATE = 'E'
AND b.RC_STATE = 'E'
AND a.CUST_BASE_INFO_ID = #{custBaseInfoId}
	</select>
	
	<!--  获取客户已购产品信息 -->
	<select id="getProductsByCustId"  parameterType="java.util.Map" resultType="java.util.Map">
		SELECT DISTINCT
			CONCAT("《",IFNULL(a.PRODUCT_NAME,""),"》") "productName",
			IFNULL(v.subscriptionFee,0) "subscriptionFee"
		FROM
			t_pd_product a,
			t_cust_base_info b,
			t_trade_info c,
			t_trade_cust_info d,
			t_trade_product_info_view v
		WHERE
			a.PRODUCT_ID = v.PRODUCT_ID
			AND c.TRADE_INFO_ID = v.TRADE_INFO_ID
			AND b.CUST_BASE_INFO_ID = d.CUST_BASE_INFO_ID
			AND c.TRADE_INFO_ID = d.TRADE_INFO_ID
			AND b.CUST_BASE_INFO_ID = #{custBaseInfoId}
			AND c.TRADE_STAUS = '10'
			AND a.RC_STATE = 'E'
			AND b.RC_STATE = 'E'
			AND c.RC_STATE = 'E'
			AND d.RC_STATE = 'E'
			GROUP BY a.PRODUCT_NAME
	</select>
</mapper>