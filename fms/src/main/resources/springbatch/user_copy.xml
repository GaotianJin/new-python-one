<beans xmlns:batch="http://www.springframework.org/schema/batch"
	xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="
	http://www.springframework.org/schema/beans
	http://www.springframework.org/schema/beans/spring-beans-2.0.xsd
	http://www.springframework.org/schema/batch
	http://www.springframework.org/schema/batch/spring-batch-2.1.xsd">

	<batch:job-repository id="jobRepository"
		data-source="dynamicDataSource" transaction-manager="transactionManager"
		isolation-level-for-create="SERIALIZABLE" table-prefix="BATCH_" />

	<bean id="userMapper" class="com.sinosoft.core.spring.batch.UserMapper" />
	<!--<batch:tasklet task-executor="taskExecutor"> <bean id="userReader" class="org.springframework.batch.item.database.JdbcCursorItemReader"> 
		<property name="dataSource" ref="dynamicDataSource" /> <property name="sql" 
		value="select a.id, a.usercode, a.username from tcuser a" /> <property name="rowMapper" 
		ref="userMapper" /> </bean> -->

	<bean id="userReader"
		class="org.springframework.batch.item.database.JdbcPagingItemReader">
		<property name="dataSource" ref="dynamicDataSource" />
		<property name="rowMapper" ref="userMapper" />
		<property name="queryProvider" ref="userQueryProvider" />
	</bean>

	<bean id="userQueryProvider"
		class="org.springframework.batch.item.database.support.OraclePagingQueryProvider">
		<property name="selectClause" value="a.id, a.usercode, a.username" />
		<property name="fromClause" value="tcuser a" />
		<property name="sortKey" value="id" />
	</bean>

	<bean id="messageProcessor" class="com.sinosoft.core.spring.batch.MessagesItemProcessor"></bean>

	<bean id="messageWriter" class="com.sinosoft.core.spring.batch.MessagesItemWriter"></bean>

	<!--commit-interval事务提交粒度(一个事务一个线程)，chunk-completion-policy完成策略，retry-limit重试次数，retryable-exception-classes可重试的异常 -->
	<batch:job id="messageJob" restartable="true">
		<batch:step id="messageStep">
			<batch:tasklet task-executor="taskExecutor"  start-limit="10"> 
			<!--<batch:tasklet>-->
				<batch:chunk reader="userReader" processor="messageProcessor"
					writer="messageWriter" commit-interval="5" chunk-completion-policy=""
					retry-limit="2">
					<batch:retryable-exception-classes>
						<batch:include class="java.lang.RuntimeException" />
					</batch:retryable-exception-classes>
				</batch:chunk>
				<batch:transaction-attributes
					isolation="DEFAULT" propagation="REQUIRED" timeout="60" />
			</batch:tasklet>
		</batch:step>
	</batch:job>

</beans>