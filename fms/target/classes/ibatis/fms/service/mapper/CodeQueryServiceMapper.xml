<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.fms.service.mapper.CodeQueryServiceMapper" >
 <select id="getAgentList" resultType="java.util.Map" parameterType="java.util.Map">
 
 <!--s-->
 
 select a.agent_id "agentId" ,a.agent_code "agentCode" ,a.agent_name "agentName" from t_agent a 
      where a.rc_state = 'E'
     <!--  <if test='storeId!=null and storeId!=""'>
        and a.store_id = #{storeId}
      </if> -->
      <if test='departmentId!=null and departmentId!=""'>
        and a.department_id = #{departmentId}
      </if>
 </select>
 
 <select id="getDefComInfo" resultType="java.util.Map" parameterType="java.util.Map">
 
 <!--S-->
    select a.com_id "comId",CONCAT(a.com_code,'-',a.com_name) "comName"
         from t_def_com a
         where a.rc_state = 'E'
          <!-- 以下是查询权限控制 3-本机构及下属机构数据，2-本机构数据，1-本人数据 -->
		<if
			test='rolePrivilege!=null and rolePrivilege!=null and rolePrivilege=="1"'> 
			and a.com_id in (select x.com_id from t_def_com x 
			                        where x.com_id = #{operComId}
                                    and x.rc_state = 'E')
		</if>
		<if
			test='rolePrivilege!=null and rolePrivilege!=null and rolePrivilege=="2" '>
           and a.com_id in (select x.com_id from t_def_com x 
			                        where x.com_id = #{operComId}
                                    and x.rc_state = 'E')
		</if>
		<if
			test='rolePrivilege!=null and rolePrivilege!=null and rolePrivilege=="3" '>
           and a.com_id in (
           <!-- SELECT Y.COM_ID FROM T_DEF_COM Y
                                    WHERE Y.RC_STATE = 'E'
                                    AND Y.STATE = '01'
                                    START WITH Y.COM_ID = #{operComId}
                                    CONNECT BY PRIOR Y.COM_ID = Y.PARENT_COM_ID -->
             select Y.COM_ID from t_def_com Y where FIND_IN_SET(Y.COM_ID, queryChildrenNodeInfo(#{operComId}))       
         )
		</if>
		<!-- 权限控制结束 -->
 </select>
 
<!--  <select id="getDefStoreInfo" resultType="java.util.Map" parameterType="java.util.Map">
 
 S
 
    select a.store_id "storeId",
           CONCAT(a.store_code,'-',a.store_name) "storeName"
           from t_def_store a where a.rc_state = 'E'
            以下是查询权限控制 3-本机构及下属机构数据，2-本机构数据，1-本人数据
		<if
			test='rolePrivilege!=null and rolePrivilege!=null and rolePrivilege=="1"'> 
			and a.store_id in (select x.store_id from t_def_store x 
							         where x.com_id = #{operComId}
							         and x.rc_state = 'E')    
		</if>
		<if
			test='rolePrivilege!=null and rolePrivilege!=null and rolePrivilege=="2" '>
           and a.store_id in (select x.store_id from t_def_store x 
							         where x.com_id = #{operComId}
							         and x.rc_state = 'E')
		</if>
		<if
			test='rolePrivilege!=null and rolePrivilege!=null and rolePrivilege=="3" '>
           and a.store_id in (select x.store_id from t_def_store x 
                                     where x.com_id in(
                                     SELECT Y.COM_ID FROM T_DEF_COM Y
                                           WHERE Y.RC_STATE = 'E'
                                           AND Y.STATE = '01'
                                           START WITH Y.COM_ID = #{operComId}
                                           CONNECT BY PRIOR Y.COM_ID = Y.PARENT_COM_ID
                                          select Y.COM_ID from t_def_com Y 
                                          where FIND_IN_SET(Y.COM_ID, queryChildrenNodeInfo(#{operComId}))
       ) 
         )
		</if>
		权限控制结束
 </select> -->
 
<!--  <select id="getDefStoreInfoByComId" resultType="java.util.Map" parameterType="java.util.Map">
    select a.store_id "storeId",
           CONCAT(a.store_code,'-',a.store_name) "storeName"
           from t_def_store a where a.rc_state = 'E'
	<if test='comId !=null and comId !=""'>
        and a.com_id = #{comId}
    </if>
 </select> -->
 <select id="getDefDepartmentInfo" resultType="java.util.Map" parameterType="java.util.Map">

 <!--S-->
    select a.department_id "departmentId",
          CONCAT(a.department_code,'-',a.department_name) "departmentName"
          from t_def_department a 
          where a.rc_state = 'E'
            <!-- 以下是查询权限控制 3-本机构及下属机构数据，2-本机构数据，1-本人数据 -->
		<if
			test='rolePrivilege!=null and rolePrivilege!=null and rolePrivilege=="1"'> 
			 and a.department_id in (select x.department_id from t_def_department x 
							         where x.com_id = #{operComId}
							         and x.rc_state = 'E')    
		</if>
		<if
			test='rolePrivilege!=null and rolePrivilege!=null and rolePrivilege=="2" '>
           and a.department_id in (select x.department_id from t_def_department x 
							         where x.com_id = #{operComId}
							         and x.rc_state = 'E')
		</if>
		<if
			test='rolePrivilege!=null and rolePrivilege!=null and rolePrivilege=="3" '>
           and a.department_id in (select x.department_id from t_def_department x 
                                     where x.com_id in(
                                     <!-- SELECT Y.COM_ID FROM T_DEF_COM Y
                                           WHERE Y.RC_STATE = 'E'
                                           AND Y.STATE = '01'
                                           START WITH Y.COM_ID = #{operComId}
                                           CONNECT BY PRIOR Y.COM_ID = Y.PARENT_COM_ID -->
                                           select Y.COM_ID from t_def_com Y 
											where FIND_IN_SET(Y.COM_ID, queryChildrenNodeInfo(#{operComId}))
       ) 
         )
		</if>
		<!-- 权限控制结束 -->
 </select>
  <select id="getDefDepartmentInfoByComId" resultType="java.util.Map" parameterType="java.util.Map">
  
  <!--S-->
    select a.department_id "departmentId", CONCAT(a.department_code,'-',a.department_name) "departmentName"
    from   t_def_department a 
    where  a.rc_state = 'E'
	<if test='comId !=null and comId !=""'>
        and a.com_id = #{comId}
    </if>
 </select>
 <select id="getAgentInfoList" resultType="java.util.Map" parameterType="java.util.Map">
    select a.agent_id "id",
          CONCAT(a.agent_code,'-',a.agent_name) "name" 
          from t_agent a where a.rc_state = 'E'
          <!-- 以下是查询权限控制 3-本机构及下属机构数据，2-本机构数据，1-本人数据 -->
		<if
			test='rolePrivilege!=null and rolePrivilege!=null and rolePrivilege=="1"'> 
			and a.agent_id in (select x.agent_id
                              from t_agent x
                                where x.com_id = #{operComId}
                                  and x.rc_state = 'E')
		</if>
		<if
			test='rolePrivilege!=null and rolePrivilege!=null and rolePrivilege=="2" '>
           and a.agent_id in (select x.agent_id
                              from t_agent x
                                where x.com_id = #{operComId}
                                  and x.rc_state = 'E')
		</if>
		<if
			test='rolePrivilege!=null and rolePrivilege!=null and rolePrivilege=="3" '>
           and a.agent_id in (select x.agent_id
                 from t_agent x
                where x.com_id in 
                      (<!-- SELECT Y.COM_ID
                         FROM T_DEF_COM Y
                        WHERE Y.RC_STATE = 'E'
                          AND Y.STATE = '01'
                        START WITH Y.COM_ID = #{operComId}
                       CONNECT BY PRIOR Y.COM_ID = Y.PARENT_COM_ID -->
                       select Y.COM_ID from t_def_com Y 
						where FIND_IN_SET(Y.COM_ID, queryChildrenNodeInfo(#{operComId}))
                       )
                  and x.rc_state = 'E')
		</if>
		<!-- 权限控制结束 -->
 </select>
 
 <select id="getCustNameByUserId" resultType="java.util.Map" parameterType="java.util.Map">
   	select a.cust_base_info_id "id",
          CONCAT(a.customer_no,'-',a.chn_name) "codeName" ,
          a.chn_name "name"
          from t_cust_base_info a ,t_agent b
          where a.rc_state = 'E'
					and b.RC_STATE = 'E'
					and a.AGENT_ID = b.AGENT_ID
         and b.USER_ID = #{userId}
 </select>
<sql id="contractNumCondition">
		<if test='productId != null and productId !="" '>
			AND B.PRODUCT_ID = #{productId}
		</if>
</sql>
 <select id="getContractNumberByPdId" resultType="java.util.Map" parameterType="java.util.Map">
   		SELECT
			a.CONTRACT_NUMBER 'id',
			a.CONTRACT_NUMBER 'name'
		FROM
			`t_pd_contract_detail` A,
			 t_pd_contract B,
			 t_pd_product  C
		WHERE
			1=1
			AND A.CONTRACT_ID = B.CONTRACT_ID
			AND B.PRODUCT_ID = C.PRODUCT_ID
			AND A.CONTRACT_STATUS = '02'
			AND	a.RC_STATE = 'E'
			AND	a.RC_STATE = 'E'
			AND	a.RC_STATE = 'E'
			<include refid="contractNumCondition" />
 </select>
</mapper>