<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">  
  
<mapper namespace="com.fms.service.mapper.PreCustomerServiceMapper">
	<!-- 查询准客户信息权限控制 -->
	<sql id="queryPreCustomerInfoListPrivilegeControl">
		<!-- 以下是查询权限控制 3-本机构及下属机构数据，2-本机构数据，1-本人数据-->
    	<if test='rolePrivilege!=null and rolePrivilege!="" and rolePrivilege=="3"'>
    	<!-- s -->
    		AND A.OPER_COM_ID IN(
   				select C.COM_ID from t_def_com C 
						where FIND_IN_SET(C.COM_ID, queryChildrenNodeInfo(#{operComId}))
						and C.rc_state='E'
    		)
    		<!-- select Y.COM_ID 
    		from t_def_com Y
			where FIND_IN_SET(Y.COM_ID, queryChildrenNodeInfo(#{operComId})) -->
    	</if>
    	<if test='rolePrivilege!=null and rolePrivilege!="" and rolePrivilege=="2" '>
    		AND A.OPER_COM_ID = #{operComId} 
    	</if>
    	<if test='rolePrivilege!=null and rolePrivilege!="" and rolePrivilege=="1" '>
    	<!-- s -->		
   		AND b.agent_id in
       (select a.agent_id
          from t_agent_department a
         where a.department_id in
               (select b.department_id
                  from t_agent_department b
                 where b.agent_id = #{loginAgentId}
                   and b.rc_state = 'E'
                   and date_format(now(), '%Y-%m-%d') <![CDATA[<=]]>
                       ifnull((date_format(a.end_date, '%Y-%m-%d')), '9999-99-99'))
           and a.rc_state = 'E'
           and exists (select 'X'
                  from t_agent_department ta
                 where ta.agent_id = #{loginAgentId}
                   and ta.isleader = 'Y')
        union all
        select tb.agent_id
          from t_agent tb
         where tb.rc_state = 'E'
           and tb.user_id = #{createUserId}
           and not exists (select 'X'
                  from t_agent_department ta1
                 where ta1.agent_id = #{loginAgentId}
                   and ta1.isleader = 'Y') )
    	</if>
    	<!-- 权限控制结束 -->
	</sql>
	 <!-- 导出准客户活动量信息权限控制 -->
	<sql id="getAllPreCustActivityInfoListPrivilegeControl">
		<!-- 以下是查询权限控制 3-本机构及下属机构数据，2-本机构数据，1-本人数据-->
    	<if test='rolePrivilege!=null and rolePrivilege!="" and rolePrivilege=="3"'>
    	<!-- s -->
    		AND E.OPER_COM_ID IN(
   				select X.COM_ID from t_def_com X 
					where FIND_IN_SET(X.COM_ID, queryChildrenNodeInfo(#{operComId}))
					and X.rc_state='E'
    		)
    	</if>
    	<if test='rolePrivilege!=null and rolePrivilege!="" and rolePrivilege=="2" '>
    		AND E.OPER_COM_ID = #{operComId} 
    	</if>
    	<if test='rolePrivilege!=null and rolePrivilege!="" and rolePrivilege=="1" '>		
    	<!-- S -->
   		 AND a.agent_id in
       (select X.agent_id
          from t_agent_department X
         where X.department_id in
               (select M.department_id
                  from t_agent_department M
                 where M.agent_id = #{loginAgentId}
                   and M.rc_state = 'E'
                   and date_format(now(), '%Y-%m-%d') <![CDATA[<=]]>
                       ifnull((date_format(X.end_date, '%Y-%m-%d')), '9999-99-99'))
           and X.rc_state = 'E'
           and exists (select 'X'
                  from t_agent_department ta
                 where ta.agent_id = #{loginAgentId}
                   and ta.isleader = 'Y')
        union all
        select tb.agent_id
          from t_agent tb
         where tb.rc_state = 'E'
           and tb.user_id = #{createUserId}
           and not exists (select 'X'
                  from t_agent_department ta1
                 where ta1.agent_id = #{loginAgentId}
                   and ta1.isleader = 'Y') )
    	</if>
    	<!-- 权限控制结束 -->
	</sql>
     <!-- 查询准客户信息查询条件 -->
  	<sql id="queryPreCustomerInfoListCondition">
  		<if test="comId != null and comId !=''" >
      		 and b.com_id = #{comId}
    	</if>
    	<if test="storeId!= null and storeId !=''" >
      		 and b.store_id = #{storeId}
    	</if>
     	<if test="agentId != null and agentId !=''" >
      		 and b.agent_id = #{agentId}
    	</if>
    	<if test="agentName != null and agentName !=''" >
      		 and b.agent_Name like '%#{agentName}%'
    	</if>
    	 <if test="agentCode != null and agentCode !=''" >
      		 and b.agent_code like '%#{agentCode}%'
    	</if>
    	<if test="departmentId != null and departmentId !=''" >
      		 and b.department_id = #{departmentId}
    	</if>
    	<if test="preCustName != null and preCustName !=''" >
      		 and a.pre_cust_name like '%'#{preCustName}%'
    	</if>
    	<if test="preCustVisitTimeStart != null and preCustVisitTimeStart !='' or preCustVisitTimeEnd!=null and preCustVisitTimeEnd!=''"  >
			<!-- s -->
			and a.pre_cust_base_info_id in
			(select distinct t.pre_cust_base_info_id
			from t_pre_customer_vistor_info t
			where 
			t.rc_state = 'E'
			<include refid="queryPreCustVisitTimeCondition"/>
			)
    	</if>
  	</sql>
    <!-- 拜访时间查询条件 -->
    <sql id="queryPreCustVisitTimeCondition">
  		<if test="preCustVisitTimeStart != null and preCustVisitTimeStart !=''" >
      		 and trunc(t.pre_cust_visit_time) <![CDATA[>=]]> DATE'${preCustVisitTimeStart}'
    	</if>
    	<if test="preCustVisitTimeEnd!= null and preCustVisitTimeEnd!=''" >
      		and trunc(t.pre_cust_visit_time) <![CDATA[<=]]>  DATE'${preCustVisitTimeEnd}'
    	</if>
  	</sql>
    <!-- 准客户活动量信息查询条件 -->
    <sql id="getAllPreCustActivityInfoCondition">
       <if test="comId != null and comId !=''" >
      		 and c.com_id = #{comId}
       </if>
     <!--   <if test="storeId!= null and storeId !=''" >
      		 and d.store_id = #{storeId}
       </if> -->
       <if test="departmentId != null and departmentId !=''">
      		 and b.department_id = #{departmentId}
       </if>
       <if test = "comName != null and comName != ''">
          and c.com_name like '%#{comName}%'
       </if>
    <!--    <if test = "storeName != null and storeName != ''">
          and d.store_name like '%#{storeName}%'
       </if> -->
       <if test = "agentId != null and agentId != ''">
          and a.agent_id = #{agentId}
       </if>
       <if test = "agentCode != null and agentCode !=''">
          and a.agent_code = #{agentCode}
       </if>
       <if test = "agentName != null and agentName != ''">
          and a.agent_name like '%#{agentName}%'
       </if>
       <if test = "departmentName != null and departmentName != ''">
          and b.department_name like '%#{departmentName}%'
       </if>
       <if test="preCustVisitStartTime != null and preCustVisitStartTime !=''">
          and cast(f.cust_visit_time as date) <![CDATA[>=]]> DATE'${preCustVisitStartTime}'
      	  <!-- and to_char(f.pre_cust_visit_time,'%Y-%m-%d %H:%i:%S') >= #{preCustVisitStartTime} -->
       </if>
       <if test="preCustVisitEndTime != null and preCustVisitEndTime !=''">
          and cast(f.cust_visit_time as date) <![CDATA[<=]]>  DATE'${preCustVisitEndTime}'
      	  <!-- and #{preCustVisitEndTime} >= to_char(f.pre_cust_visit_time,'%Y-%m-%d %H:%i:%S') -->
       </if> 
    </sql>
    <!-- 准客户信息查询 -->
  	<select id="preCustomerQueryListPage" parameterType="java.util.Map" resultType="java.util.Map">
  		<!-- S -->
         	select a.pre_cust_base_info_id "preCustBaseInfoId",
			       a.pre_cust_no "preCustNo",
			       a.pre_cust_name "preCustName",
			       a.pre_cust_mobile "preCustMobile",
			       a.pre_cust_type "preCustTypeCode",
			        a.pre_cust_building_no "preCustBuildingNo",
			       (select t.code_name
			          from t_Def_Code t
			         where t.code_type = 'customerType'
			           and t.code = a.pre_cust_type) "preCustType",
       				a.pre_cust_residential_building "preCustResidentialBuildingCode",
			       (select t.building_name
			          from t_def_building t
			         where t.rc_state = 'E'
			           and t.building_id = a.pre_cust_residential_building) "preCustResidentialBuilding",
       			a.pre_cust_obtain_way "preCustObtainWayCode",
			       (select t.code_name
			          from t_Def_Code t
			         where t.code_type = 'preCustObtailWay'
			           and t.code = a.pre_cust_obtain_way) "preCustObtainWay",
			       b.agent_id "agentId",
			       b.agent_code "agentCode",
			       b.agent_name "agentName",
             	(select date_format(max(m.pre_cust_visit_time),'%Y-%m-%d %H:%i:%S') 
             		from t_pre_customer_vistor_info m 
                     where m.pre_cust_base_info_id = a.pre_cust_base_info_id and m.rc_state = 'E') "lastPreCustVisitTime",
             	(select count(1) from t_pre_customer_vistor_info m 
                     where m.pre_cust_base_info_id = a.pre_cust_base_info_id and m.rc_state = 'E') "visitTimes"
			  from t_Pre_Customer_Base_Info a, t_agent b
			 where a.rc_state = 'E'
			   and b.rc_state = 'E'
			   and a.pre_agent_id = b.agent_id 
			   <include refid = "queryPreCustomerInfoListCondition"/> 
			   <include refid = "queryPreCustomerInfoListPrivilegeControl"/>
 				order by a.pre_cust_base_info_id desc
 			LIMIT #{startIndex} , #{endIndex} 
    </select> 
    
    <select id="preCustomerQueryListCount" parameterType="java.util.Map" resultType="java.lang.Integer">
    <!-- s -->
		select count(1)
  		from t_Pre_Customer_Base_Info a, t_agent b
 		where a.rc_state = 'E'
   		and b.rc_state = 'E'
   		and a.pre_agent_id = b.agent_id 
   		<include refid = "queryPreCustomerInfoListCondition"/> 
   		<include refid = "queryPreCustomerInfoListPrivilegeControl"/>
    </select> 
    
    
    <!-- 准客户拜访时间信息查询 -->
  	<select id="preCustomerQueryVisitTime" parameterType="java.util.Map" resultType="java.util.Map">
  	<!-- s -->
   select a.pre_cust_visitor_info_id "preCustVisitorInfoId",
          
          date_format(a.pre_cust_visit_time, '%Y-%m-%d %H:%i:%S') "preCustVisitTime",
          
          a.pre_cust_visit_type "preCustVisitType",
          
         group_concat( a.pre_cust_visit_type , '-' ,
          (select t.code_name
             from t_Def_Code t
            where t.code = a.pre_cust_visit_type
              and t.code_type = 'preCustVisitType')) "preCustVisitTypeName",
          
          a.pre_cust_visit_action "preCustVisitAction",
          a.pre_cust_visit_action "preCustVisitActionValue",
          
          (select concat(b.code , '-' , b.code_name)
             from t_def_code b
            where b.code_type = 'preCustVisitAction'
              and instr(a.pre_cust_visit_action, b.code) > 0) "preCustVisitActionName",
          
          a.pre_cust_visit_content "preCustVisitContent"
   
     from t_pre_customer_vistor_info a
    where a.pre_cust_base_info_id = #{preCustBaseInfoId}
      and a.rc_state = 'E'
    order by a.pre_cust_visit_time desc
    </select> 
    <!-- 准客户活动量信息查询 -->
    <select id="getAllPreCustActivityInfo" parameterType="java.util.Map" resultType="java.util.Map">
    <!-- s -->
		<!-- select a.agent_name "agentName",b.department_name "departmentName",c.com_name "comName",d.store_name "storeName",
		       e.pre_cust_no "preCustNo",e.pre_cust_name "preCustName",a.agent_id "agentId",
		       FUNC_GET_CODE_NAME('preCustVisitType',f.pre_cust_visit_type) "preCustVisitType",
		       (select to_char(wm_concat(g.code || '-' || g.code_name))
               from t_def_code g where g.code_type = 'preCustVisitAction'
               and instr(f.pre_cust_visit_action, g.code) > 0) "preCustVisitAction",
		       to_char(f.pre_cust_visit_time,'%Y-%m-%d %H:%i:%S') "preCustVisitTime"
		       from t_agent a ,t_def_department b,t_def_com c,t_def_store d,t_pre_customer_base_info e,t_pre_customer_vistor_info f 
		       where a.department_id = b.department_id
		       and a.com_id = c.com_id
		       and a.store_id = d.store_id
		       and e.pre_agent_id = a.agent_id
		       and f.pre_cust_base_info_id = e.pre_cust_base_info_id
		       and a.rc_state = 'E'
		       and b.rc_state = 'E'
		       and c.rc_state = 'E'
		       and e.rc_state = 'E'
		       and f.rc_state = 'E' -->
	   <!--  select a.agent_name "agentName",b.department_name "departmentName",c.com_name "comName",d.store_name "storeName",
	           e.customer_no "preCustNo",e.chn_name "preCustName",a.agent_id "agentId",
	           FUNC_GET_CODE_NAME('preCustVisitType',f.cust_visit_type) "preCustVisitType",
	           (select to_char(wm_concat(g.code || '-' || g.code_name))
	               from t_def_code g where g.code_type = 'preCustVisitAction'
	               and instr(f.cust_visit_action, g.code) > 0) "preCustVisitAction",
	           to_char(f.cust_visit_time,'%Y-%m-%d %H:%i:%S') "preCustVisitTime"
	           from t_agent a ,t_def_department b,t_def_com c,t_def_store d,t_cust_base_info e,t_cust_visit_info f 
	           where a.department_id = b.department_id
	           and a.com_id = c.com_id
	           and a.store_id = d.store_id
	           and e.agent_id = a.agent_id
	           and e.cust_base_info_id = f.cust_base_info_id
	           and f.agent_id = e.agent_id
	           and a.rc_state = 'E'
	           and b.rc_state = 'E'
	           and c.rc_state = 'E'
	           and e.rc_state = 'E'
	           and f.rc_state = 'E' -->
			select   
                  a.agent_name        			 "agentName",
                  b.department_name     "departmentName",
                  c.com_name           			"comName",
               <!--    d.store_name         			"storeName", -->
                  e.customer_no        		"preCustNo",
                  e.chn_name           			"preCustName",
                  a.agent_id           				"agentId",
                  FUNC_GET_CODE_NAME('preCustVisitType',f.cust_visit_type) "preCustVisitType",
                  (select group_concat(g.code , '-' , g.code_name) from t_def_code g 
                  where g.code_type = 'preCustVisitAction' and instr(f.cust_visit_action, g.code) > 0)   "preCustVisitAction",
                  date_format(f.cust_visit_time,'%Y-%m-%d %H:%i:%S')                  "preCustVisitTime"
               from 
                    t_cust_base_info e INNER JOIN t_cust_visit_info f ON (e.cust_base_info_id = f.cust_base_info_id and f.rc_state = 'E')
                    LEFT JOIN t_agent a ON (e.agent_id = a.agent_id and a.rc_state = 'E')
                    LEFT JOIN t_def_com c ON (a.com_id = c.com_id and c.rc_state = 'E')
                    LEFT JOIN t_def_department b ON (a.department_id = b.department_id and b.rc_state = 'E')
                    <!-- LEFT JOIN t_def_store d ON (a.store_id = d.store_id and d.rc_state = 'E') -->
               where        
                    e.rc_state = 'E'
			   		<include refid = "getAllPreCustActivityInfoCondition"/> 
			   		<include refid = "getAllPreCustActivityInfoListPrivilegeControl"/>
			   order by f.cust_visit_time desc
 		LIMIT #{startIndex} , #{endIndex} 
    </select>
    <!-- 准客户活动量信息条数查询 -->
    <select id="getAllPreCustActivityInfoCount" parameterType="java.util.Map" resultType="java.lang.Integer">
    <!-- s -->
		       select   
		                 count(1)
               from 
                    t_cust_base_info e INNER JOIN t_cust_visit_info f ON (e.cust_base_info_id = f.cust_base_info_id and f.rc_state = 'E')
                    LEFT JOIN t_agent a ON (e.agent_id = a.agent_id and a.rc_state = 'E')
                    LEFT JOIN t_def_com c ON (a.com_id = c.com_id and c.rc_state = 'E')
                    LEFT JOIN t_def_department b ON (a.department_id = b.department_id and b.rc_state = 'E')
                    LEFT JOIN t_def_store d ON (a.store_id = d.store_id and d.rc_state = 'E')
               where        
                    e.rc_state = 'E'
			   <include refid = "getAllPreCustActivityInfoCondition"/> 
			   <include refid = "getAllPreCustActivityInfoListPrivilegeControl"/>
    </select>
    <!-- 导出准客户活动量信息详情 -->
    <select id="preCustActivityDetail" parameterType="java.util.Map" resultType="java.util.Map">
    <!-- s -->
     <!--  select 
      	a.agent_name 		"agentName",
      	b.department_name 	"departmentName",
      	c.com_name 			"comName",
      	d.store_name 		"storeName",
        e.pre_cust_no 		"preCustNo",
        e.pre_cust_name 	"preCustName",
        e.pre_cust_mobile 	"preCustMobile",
        a.agent_id 			"agentId",
        FUNC_GET_CODE_NAME('sex',e.pre_cust_sex) "preCustSex",
        FUNC_GET_CODE_NAME('customerType',e.pre_cust_type) "preCustType",
        (select h.building_name from t_def_building h where h.building_id = e.pre_cust_residential_building)  "preCustResidentialBuilding",
        FUNC_GET_CODE_NAME('preCustObtailWay',e.pre_cust_obtain_way) "preCustObtainWay",
        f.pre_cust_visit_content "preCustVisitContent",
        FUNC_GET_CODE_NAME('preCustVisitType',f.pre_cust_visit_type) "preCustVisitType",
        (select 
        	to_char(wm_concat(g.code || '-' || g.code_name))
         from t_def_code g 
         where g.code_type = 'preCustVisitAction' and instr(f.pre_cust_visit_action, g.code) > 0)  "preCustVisitAction",
        to_char(f.pre_cust_visit_time,'%Y-%m-%d %H:%i:%S') "preCustVisitTime"
    from t_agent a ,t_def_department b,t_def_com c,t_def_store d,t_pre_customer_base_info e,t_pre_customer_vistor_info f 
    where a.department_id = b.department_id
           and a.com_id = c.com_id
           and a.store_id = d.store_id
           and e.pre_agent_id = a.agent_id
           and f.pre_cust_base_info_id = e.pre_cust_base_info_id
           and a.rc_state = 'E'
           and b.rc_state = 'E'
           and c.rc_state = 'E'
           and e.rc_state = 'E'
           and f.rc_state = 'E' -->
           select 
		        a.agent_name     "agentName",
		        b.department_name   "departmentName",
		        c.com_name       "comName",
		        e.customer_no     "preCustNo",
		        e.chn_name   "preCustName",
		        i.mobile   "preCustMobile",
		        a.agent_id       "agentId",
		        FUNC_GET_CODE_NAME('sex',e.sex) "preCustSex",
		        FUNC_GET_CODE_NAME('customerType',o.cust_type) "preCustType",
		        (select h.building_name from t_def_building h where h.building_id = o.building_name)  "preCustResidentialBuilding",
		        FUNC_GET_CODE_NAME('custObtainWay',e.cust_obtain_way) "preCustObtainWay",
		        f.cust_visit_content "preCustVisitContent",
		        FUNC_GET_CODE_NAME('preCustVisitType',f.cust_visit_type) "preCustVisitType",
		        (select 
		          group_concat(g.code , '-' , g.code_name)
		         from t_def_code g 
		         where g.code_type = 'preCustVisitAction' and instr(f.cust_visit_action, g.code) > 0)  "preCustVisitAction",
		        date_format(f.cust_visit_time,'%Y-%m-%d %H:%i:%S') "preCustVisitTime"
		    from t_agent a ,t_def_department b,t_def_com c,t_cust_base_info e,t_cust_visit_info f,
		    t_cust_contact_info i,t_cust_oth_info o
		    where a.department_id = b.department_id
		           and a.com_id = c.com_id
		           and e.agent_id = a.agent_id
		           and f.cust_base_info_id = e.cust_base_info_id
		           and e.cust_base_info_id = i.cust_base_info_id
		           and e.cust_base_info_id = o.cust_base_info_id
		           and e.agent_id = f.agent_id
		           and a.rc_state = 'E'
		           and b.rc_state = 'E'
		           and c.rc_state = 'E'
		           and e.rc_state = 'E'
		           and f.rc_state = 'E'
		           and i.rc_state = 'E'
                   and o.rc_state = 'E'
           <include refid = "getAllPreCustActivityInfoCondition"/> 
		   <include refid = "getAllPreCustActivityInfoListPrivilegeControl"/>
		   order by f.cust_visit_time desc   
    </select>
    <!-- 导出准客户活动量管理打分表信息详情 -->
    <select id="queryPreCustActivityScoreManagementDetail" parameterType="java.util.Map" resultType="java.util.Map">
    <!-- s -->
		<!-- select h.*, 
		"nameListObtained" 
		+ "apointmentVisit" 
		+ "interview" 
		+ "companyIntroduction" 
		+ "selfIntroduction" 
		+ "baobaoFinancialIntroduction"
		+ "assetManagementIntroduction" 
		+ "privateEquityFundIntroduction"
		+ "insurancefIntroduction"
		+ "financleIntroduction"
		+ "weixinAccountIntroduction"
		+ "appDownload"  "teamLeaderEvaluate"
		from 
		(select 
		           to_char(f.pre_cust_visit_time, '%Y-%m-%d')  "visitDay",
		           a.agent_name   "agentName",
		           count(CASE WHEN f.pre_cust_visit_type IN('01') THEN 'obtainNameOrder' END)  "nameListObtained",
		           count(CASE WHEN f.pre_cust_visit_type IN('02') THEN 'visit' END)   "apointmentVisit",
		           count(CASE WHEN f.pre_cust_visit_type IN('03') THEN 'interview' END)   "interview"，
		           count(CASE WHEN INSTR(f.pre_cust_visit_action,'01') > 0 THEN 'companyIntroduction' ELSE null END)   "companyIntroduction",
		           count(CASE WHEN instr(f.pre_cust_visit_action,'02') > 0 THEN 'selfIntroduction' ELSE null END)   "selfIntroduction",
		           count(CASE WHEN instr(f.pre_cust_visit_action,'03') > 0 THEN 'baobaoFinancialIntroduction' ELSE null END)   "baobaoFinancialIntroduction",
		           count(CASE WHEN instr(f.pre_cust_visit_action,'04') > 0 THEN 'assetManagementIntroduction' ELSE null END)   "assetManagementIntroduction",
		           count(CASE WHEN instr(f.pre_cust_visit_action,'05') > 0 THEN 'privateEquityFundIntroduction' ELSE null END)    "privateEquityFundIntroduction",
		           count(CASE WHEN instr(f.pre_cust_visit_action,'06') > 0 THEN 'insurancefIntroduction' ELSE null END)      "insurancefIntroduction",
		           count(CASE WHEN instr(f.pre_cust_visit_action,'07') > 0 THEN 'financleIntroduction' ELSE null END)      "financleIntroduction",
		           count(CASE WHEN instr(f.pre_cust_visit_action,'08') > 0 THEN 'weixinAccountIntroduction' ELSE null END)    "weixinAccountIntroduction",
		           count(CASE WHEN instr(f.pre_cust_visit_action,'09') > 0 THEN 'appDownload' ELSE null END)            "appDownload"
		    from
		        (select * from t_pre_customer_vistor_info where rc_state = 'E') f
		        inner join
		        (select * from  t_pre_customer_base_info  where rc_state = 'E') e
		        on f.pre_cust_base_info_id = e.pre_cust_base_info_id
		        left join
		        (select * from t_agent where rc_state = 'E') a
		        on a.agent_id = e.pre_agent_id
		        left join
		        (select * from t_def_department where rc_state = 'E') b
		        on a.department_id = b.department_id
		        left join
		        (select * from t_def_com where rc_state = 'E') c
		        on a.com_id = c.com_id
		        left join
		        (select * from t_def_store where rc_state = 'E') d
		        on a.store_id = d.store_id
		    where
		        f.rc_state = 'E'
		        <include refid = "getAllPreCustActivityInfoCondition"/> 
		   		<include refid = "getAllPreCustActivityInfoListPrivilegeControl"/>
		    group by to_char(f.pre_cust_visit_time, '%Y-%m-%d'), a.agent_name 
		    order by to_char(f.pre_cust_visit_time, '%Y-%m-%d') desc, a.agent_name asc
		) h -->
		select h.*, 
			    nameListObtained 
			    + apointmentVisit 
			    + interview 
			    + companyIntroduction 
			    + selfIntroduction 
			    + baobaoFinancialIntroduction
			    + assetManagementIntroduction 
			    + privateEquityFundIntroduction
			    + insurancefIntroduction
			    + financleIntroduction
			    + weixinAccountIntroduction
			    + appDownload  "teamLeaderEvaluate"
			    from 
        (select 
               date_format(f.cust_visit_time, '%Y-%m-%d')  "visitDay",
               a.agent_name   "agentName",
               count(CASE WHEN f.cust_visit_type IN('01') THEN 'obtainNameOrder' END)  "nameListObtained",
               count(CASE WHEN f.cust_visit_type IN('02') THEN 'visit' END)   "apointmentVisit",
               count(CASE WHEN f.cust_visit_type IN('03') THEN 'interview' END)   "interview",
               count(CASE WHEN INSTR(f.cust_visit_action,'01') > 0 THEN 'companyIntroduction' ELSE null END)   "companyIntroduction",
               count(CASE WHEN instr(f.cust_visit_action,'02') > 0 THEN 'selfIntroduction' ELSE null END)   "selfIntroduction",
               count(CASE WHEN instr(f.cust_visit_action,'03') > 0 THEN 'baobaoFinancialIntroduction' ELSE null END)   "baobaoFinancialIntroduction",
               count(CASE WHEN instr(f.cust_visit_action,'04') > 0 THEN 'assetManagementIntroduction' ELSE null END)   "assetManagementIntroduction",
               count(CASE WHEN instr(f.cust_visit_action,'05') > 0 THEN 'privateEquityFundIntroduction' ELSE null END)    "privateEquityFundIntroduction",
               count(CASE WHEN instr(f.cust_visit_action,'06') > 0 THEN 'insurancefIntroduction' ELSE null END)      "insurancefIntroduction",
               count(CASE WHEN instr(f.cust_visit_action,'07') > 0 THEN 'financleIntroduction' ELSE null END)      "financleIntroduction",
               count(CASE WHEN instr(f.cust_visit_action,'08') > 0 THEN 'weixinAccountIntroduction' ELSE null END)    "weixinAccountIntroduction",
               count(CASE WHEN instr(f.cust_visit_action,'09') > 0 THEN 'appDownload' ELSE null END)            "appDownload"
        from
            (select * from t_cust_visit_info where rc_state = 'E') f
            inner join
            (select * from  t_cust_base_info  where rc_state = 'E') e
            on f.cust_base_info_id = e.cust_base_info_id
            left join
            (select * from t_agent where rc_state = 'E') a
            on a.agent_id = e.agent_id
            left join
            (select * from t_def_department where rc_state = 'E') b
            on a.department_id = b.department_id
            left join
            (select * from t_def_com where rc_state = 'E') c
            on a.com_id = c.com_id
            left join
            (select * from t_def_store where rc_state = 'E') d
            on a.store_id = d.store_id
        where
            f.rc_state = 'E'
            <include refid = "getAllPreCustActivityInfoCondition"/> 
		   	<include refid = "getAllPreCustActivityInfoListPrivilegeControl"/>
        group by date_format(f.cust_visit_time, '%Y-%m-%d'), a.agent_name 
        order by date_format(f.cust_visit_time, '%Y-%m-%d') desc, a.agent_name asc
    ) h
    
   
    </select>
</mapper>  