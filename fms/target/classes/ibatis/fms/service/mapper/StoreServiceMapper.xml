<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.fms.service.mapper.StoreServiceMapper" >
	
	<sql id="queryStoreListInfoSQL">
	
		select 
		(SELECT @rownum := 0),
	      a.store_id   		"storeId",
	      a.store_code    	"storeCode",
	      a.store_name    	"storeName",
	      b.com_name        "parentComId",
	      c.code_name       "storeState",
	      d.code_name       "storeType",
	      f.building_name 	"buildingName",
	      a.phone        	"phone",
	      a.manager_name 	"managerName",
	      a.manager_mobile 	"managerMobile" 
	    from t_def_store a
	    left join t_def_com b
	    on a.com_id = b.com_id
	    and b.rc_state='E'
	    left join t_def_building f
	    on a.building_id=f.building_id
	    and f.rc_state='E'
	    left join t_def_code c
	    on a.state=c.code
	    and c.code_type='storeState'
	    left join t_def_code d
	    on a.type=d.code
	    and d.code_type='storeType'
     	where 1 = 1 and a.rc_state='E'
		<if test="storeCode!=null and storeCode!=''">
		   	and a.store_code like '%${storeCode}%'
		</if>
		<if test="storeName!=null and storeName!=''">
		   	and a.store_name like '%${storeName}%'
		</if>
		<if test="comId!=null and comId!=''">
		   	and a.com_id = #{comId}
		</if>
		<if test="type!=null and type!=''">
		   	and a.type = #{type}
		</if>
		<if test="buildingId!=null and buildingId!=''">
		   	and a.building_Id = #{buildingId}
		</if>
	</sql>
	
	
	<!-- 机构信息列表查询（全部） -->
	<select id="queryStoreListCode" resultType="java.util.Map" parameterType="java.util.Map" >
		SELECT
			store_Id "id",
			<!-- 机构编码 -->
			CONCAT(store_code,'-',store_name) "name" <!-- 机构名称 -->
		FROM
			t_def_store
		WHERE
			rc_state = 'E'
	</select>
	
	
	<!-- 机构信息列表查询（全部） -->
	<select id="queryStoreBelongListInfo" resultType="java.util.Map" parameterType="java.util.Map" >
       select 
	      tsbc.BLCOM_ID                    "blcomId",
	      tsbc.STORE_ID                    "storeId",
	      tsbc.COM_ID                      "comId",
	      CONCAT(tdc.com_code,'-',tdc.com_name) "belongComName",
	      tsbc.START_DATE                  "startDate",
	      tsbc.END_DATE                    "endDate",
	      tsbc.RC_STATE                    "rcState",
	      tsbc.CREATE_DATE                 "createDate",
	      tsbc.MODIFY_DATE                 "modifyDate",       
	      tsbc.OPER_COM_ID                 "operComId",
	      tsbc.CREATE_USER_ID              "createUserId",
	      tsbc.MODIFY_USER_ID              "modifyUserId"
	    from t_store_belong_com_trace tsbc
	    left join t_def_com tdc
	    on tsbc.com_id=tdc.com_id
	    and tdc.rc_state='E'
	    where tsbc.rc_state='E' and tsbc.STORE_ID = #{storeId}
	    <if test="blcomId!=null and blcomId!=''">
	         and BLCOM_ID=#{blcomId}
	    </if>   
	</select>
	
	<!-- 根据网点名称查询 -->
	<select id="queryStoreByStoreName" resultType="com.fms.db.model.DefStore" parameterType="com.fms.db.model.DefStore" >
		 SELECT
			store_id "storeId",
			store_name "storeName",
			store_code "storeCode"
		FROM
			t_def_store
		WHERE
			rc_state = 'E'
		AND store_name = #{storeName}
	</select>
	
	<!-- 根据网点代码查询 -->
	<select id="queryStoreByStoreCode" resultType="com.fms.db.model.DefStore" parameterType="com.fms.db.model.DefStore" >
		SELECT
			store_id "storeId",
			store_name "storeName",
			store_code "storeCode"
		FROM
			t_def_store
		WHERE
			rc_state = 'E'
		<if test="storeId!=null and storeId!=''">
		   	and store_id != #{storeId}
		</if>
		and store_code = #{storeCode}
	</select>
	
	<!-- 机构信息列表查询（总记录数） -->
	<select id="queryStoreListInfoCounts" resultType="java.lang.Integer" parameterType="java.util.Map" >
		select count(1) from 
		(
      	  	<include refid="queryStoreListInfoSQL"/>
        )a
	</select>
	
	<!-- 机构信息列表查询（分页查询） -->
	<select id="queryStoreListInfoPages" resultType="java.util.Map" parameterType="java.util.Map" >
	
        select tAlias.* from
		(
	         select nAlias.*, @rownum:=@rownum+1 r_rownum from
	         (
		         <include refid="queryStoreListInfoSQL"/>
		         
			 ) nAlias
		) tAlias where r_rownum >=#{queryStartIndex} and #{queryEndIndex} >= r_rownum
	</select>
	
</mapper>